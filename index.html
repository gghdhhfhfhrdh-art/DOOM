<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>DOOM Raycaster ‚Äî Nova Studio</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { background: #000; overflow: hidden; font-family: 'Courier New', monospace; }
        
        /* ========= NOVA STUDIO INTRO ========= */
        #novaIntro {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 99999; background: #000; display: flex; justify-content: center;
            align-items: center; flex-direction: column; cursor: default;
        }
        #novaCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .nova-text-wrap { position: relative; z-index: 2; text-align: center; pointer-events: none; }
        .nova-studio {
            font-size: clamp(28px, 6vw, 72px); font-weight: 100; letter-spacing: 0.6em;
            color: transparent; user-select: none;
            background: linear-gradient(180deg, #fff 0%, #888 100%);
            -webkit-background-clip: text; background-clip: text;
            opacity: 0; transition: opacity 1.5s ease;
        }
        .nova-studio.visible { opacity: 1; }
        .nova-studio.colored {
            background: linear-gradient(180deg, #ff4444 0%, #ff8800 50%, #ffcc00 100%);
            -webkit-background-clip: text; background-clip: text;
            text-shadow: 0 0 60px rgba(255,68,0,0.8), 0 0 120px rgba(255,0,0,0.4);
            filter: none;
        }
        .nova-presents {
            font-size: clamp(10px, 1.5vw, 16px); letter-spacing: 0.4em;
            color: #555; margin-top: 12px; opacity: 0; transition: opacity 1s ease 0.5s;
        }
        .nova-presents.visible { opacity: 1; }
        .nova-skip {
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            font-size: 11px; color: #333; letter-spacing: 2px; z-index: 3;
            animation: skipPulse 2s ease-in-out infinite;
        }
        @keyframes skipPulse { 0%,100%{opacity:0.3} 50%{opacity:0.7} }

        /* ========= LOAD SCREEN ========= */
        #loadScreen {
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            z-index: 9999; display: none; flex-direction: column;
            justify-content: center; align-items: center; cursor: default; background: #000;
        }
        #loadScreen.active { display: flex; }
        #loadCanvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; }
        .load-ui { position: relative; z-index: 2; display: flex; flex-direction: column; align-items: center; pointer-events: none; }
        .load-ui.interactive { pointer-events: all; }
        .doom-title {
            font-size: clamp(48px, 10vw, 120px); font-weight: 900;
            color: #ff2222; letter-spacing: 0.15em;
            text-shadow: 0 0 40px #ff0000, 0 0 80px #aa0000, 0 0 120px #660000, 0 4px 0 #880000, 0 8px 0 #440000;
            animation: titleFloat 3s ease-in-out infinite, titleGlow 2s ease-in-out infinite alternate;
            user-select: none;
        }
        @keyframes titleFloat { 0%,100%{transform:translateY(0) scale(1)} 50%{transform:translateY(-12px) scale(1.02)} }
        @keyframes titleGlow {
            0%{text-shadow:0 0 40px #ff0000,0 0 80px #aa0000,0 0 120px #660000,0 4px 0 #880000,0 8px 0 #440000}
            100%{text-shadow:0 0 60px #ff3333,0 0 120px #cc0000,0 0 200px #880000,0 4px 0 #aa0000,0 8px 0 #660000}
        }
        .load-subtitle { color: #aa4444; font-size: clamp(10px,2vw,16px); letter-spacing: 6px; margin-top: 8px; animation: sp 2s ease-in-out infinite; }
        @keyframes sp { 0%,100%{opacity:0.6} 50%{opacity:1} }
        .load-progress-wrap { margin-top: 40px; width: clamp(200px,50vw,500px); height: 6px; background: #1a0808; border: 1px solid #441111; border-radius: 3px; overflow: hidden; }
        .load-progress-bar { height: 100%; width: 0%; background: linear-gradient(90deg,#ff2222,#ff6644,#ff2222); background-size: 200% 100%; animation: ps 1.5s linear infinite; border-radius: 3px; transition: width 0.3s ease; }
        @keyframes ps { 0%{background-position:200% 0} 100%{background-position:-200% 0} }
        .load-status { color: #664444; font-size: 11px; margin-top: 10px; letter-spacing: 2px; min-height: 16px; }
        .map-select { display: flex; gap: 12px; margin: 30px 0 20px; flex-wrap: wrap; justify-content: center; }
        .map-card { width: 130px; padding: 14px 10px; background: rgba(26,8,8,0.9); border: 2px solid #442222; color: #cc8888; text-align: center; cursor: pointer; transition: all 0.3s; border-radius: 8px; }
        .map-card:hover,.map-card.selected { border-color: #ff4444; background: rgba(42,16,16,0.95); color: #ff6666; transform: scale(1.08) translateY(-4px); box-shadow: 0 8px 30px rgba(255,50,50,0.3); }
        .map-card .map-name { font-size: 13px; font-weight: bold; margin-bottom: 4px; }
        .map-card .map-desc { font-size: 9px; color: #886666; }
        .start-btn { padding: 16px 60px; font-family: 'Courier New',monospace; font-size: 20px; font-weight: bold; background: transparent; color: #ff4444; border: 2px solid #ff4444; cursor: pointer; letter-spacing: 4px; transition: all 0.3s; border-radius: 4px; position: relative; overflow: hidden; }
        .start-btn::before { content:''; position:absolute; top:0; left:-100%; width:100%; height:100%; background:linear-gradient(90deg,transparent,rgba(255,68,68,0.2),transparent); animation:bs 2s infinite; }
        @keyframes bs { 0%{left:-100%} 100%{left:100%} }
        .start-btn:hover { background:#ff4444; color:#fff; box-shadow:0 0 40px rgba(255,68,68,0.5); transform:scale(1.05); }
        .hint { color: #444; font-size: 10px; margin-top: 20px; letter-spacing: 1px; max-width: 700px; text-align: center; line-height: 1.6; }
        .hidden { display: none !important; }
        canvas#game { display: none; width: 100vw; height: 100vh; image-rendering: pixelated; cursor: none; }
        canvas#game.active { display: block; }
        .overlay { display:none; position:fixed; top:0; left:0; right:0; bottom:0; z-index:1000; justify-content:center; align-items:center; }
        .overlay.open { display:flex; }
        #deathScreen { background:rgba(0,0,0,0); z-index:1500; flex-direction:column; cursor:default; transition:background 1s; }
        #deathScreen.open { background:rgba(60,0,0,0.92); }
        #deathScreen h1 { color:#ff0000; font-size:64px; text-shadow:0 0 40px #ff0000; letter-spacing:8px; margin-bottom:16px; animation:dp 1s infinite; }
        @keyframes dp { 0%,100%{transform:scale(1);opacity:1} 50%{transform:scale(1.05);opacity:0.8} }
        #deathScreen .death-stats { color:#cc8888; font-size:15px; margin-bottom:30px; text-align:center; line-height:1.8; }
        #winScreen { background:rgba(0,0,0,0); z-index:1500; flex-direction:column; cursor:default; transition:background 1s; }
        #winScreen.open { background:rgba(0,40,0,0.92); }
        #winScreen h1 { color:#00ff44; font-size:48px; text-shadow:0 0 40px #00ff44; letter-spacing:8px; margin-bottom:16px; }
        #winScreen .win-stats { color:#88cc88; font-size:15px; margin-bottom:30px; text-align:center; line-height:1.8; }
        #settingsOverlay { background:rgba(0,0,0,0.88); z-index:1000; }
        #settingsPanel { background:linear-gradient(135deg,#1a0a0a,#2a1515); border:2px solid #ff4444; border-radius:8px; padding:24px 32px; color:#ddd; min-width:520px; max-width:600px; box-shadow:0 0 60px rgba(255,50,50,0.3); max-height:85vh; overflow-y:auto; }
        #settingsPanel h2 { color:#ff4444; text-align:center; font-size:22px; margin-bottom:16px; text-shadow:0 0 10px #ff0000; letter-spacing:3px; }
        .setting-group { margin-bottom:14px; }
        .setting-group label { display:block; color:#aaa; font-size:11px; margin-bottom:5px; text-transform:uppercase; letter-spacing:1px; }
        .setting-group input[type="range"] { width:100%; accent-color:#ff4444; height:5px; cursor:pointer; }
        .range-value { color:#ff6666; float:right; font-size:11px; }
        .setting-group select { width:100%; padding:5px 8px; background:#111; color:#ddd; border:1px solid #555; border-radius:4px; font-family:'Courier New',monospace; font-size:12px; cursor:pointer; }
        .keybind-row { display:flex; justify-content:space-between; align-items:center; padding:4px 0; border-bottom:1px solid #222; }
        .keybind-row span { font-size:12px; }
        .keybind-btn { background:#222; color:#ff6666; border:1px solid #555; padding:3px 12px; font-family:'Courier New',monospace; font-size:11px; cursor:pointer; border-radius:3px; min-width:70px; text-align:center; }
        .keybind-btn:hover { background:#333; border-color:#ff4444; }
        .keybind-btn.listening { background:#440000; border-color:#ff0000; color:#fff; animation:pulse 0.6s infinite; }
        @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.5} }
        .checkbox-label { font-size:12px; cursor:pointer; }
        .setting-group input[type="checkbox"] { accent-color:#ff4444; width:14px; height:14px; cursor:pointer; vertical-align:middle; margin-right:6px; }
        .btn-row { display:flex; justify-content:space-between; margin-top:20px; gap:10px; }
        .menu-btn { flex:1; padding:8px; font-family:'Courier New',monospace; font-size:13px; font-weight:bold; border:2px solid #555; border-radius:4px; cursor:pointer; letter-spacing:1px; transition:all 0.15s; }
        .menu-btn.primary { background:#aa2222; color:#fff; border-color:#ff4444; }
        .menu-btn.primary:hover { background:#cc3333; }
        .menu-btn.secondary { background:#222; color:#aaa; }
        .menu-btn.secondary:hover { background:#333; color:#fff; }
        .tabs { display:flex; gap:3px; margin-bottom:14px; }
        .tab-btn { flex:1; padding:7px; text-align:center; background:#111; color:#888; border:1px solid #333; cursor:pointer; font-family:'Courier New',monospace; font-size:11px; text-transform:uppercase; letter-spacing:1px; }
        .tab-btn.active { background:#331111; color:#ff4444; border-color:#ff4444; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .weapon-bar { position:fixed; bottom:0; left:50%; transform:translateX(-50%); display:none; gap:4px; padding:6px 10px; background:rgba(0,0,0,0.7); border-top:1px solid #444; border-radius:6px 6px 0 0; z-index:100; }
        .weapon-bar.active { display:flex; }
        .weapon-slot { width:48px; height:48px; border:2px solid #444; background:#111; display:flex; flex-direction:column; align-items:center; justify-content:center; cursor:pointer; border-radius:4px; transition:all 0.15s; position:relative; }
        .weapon-slot:hover { border-color:#888; }
        .weapon-slot.active { border-color:#ff4444; background:#2a1010; box-shadow:0 0 10px rgba(255,50,50,0.4); }
        .weapon-slot .wnum { position:absolute; top:2px; left:4px; font-size:8px; color:#666; }
        .weapon-slot .wicon { font-size:18px; }
        .weapon-slot .wname { font-size:7px; color:#888; margin-top:1px; }
        #msgLog { position:fixed; top:80px; left:12px; z-index:90; pointer-events:none; }
        .msg-line { color:#fff; font-size:12px; font-family:'Courier New',monospace; text-shadow:0 0 6px #000,0 0 12px #000; margin-bottom:3px; transition:opacity 0.5s; white-space:nowrap; }
    </style>
</head>
<body>

<!-- ============ NOVA STUDIO INTRO ============ -->
<div id="novaIntro">
    <canvas id="novaCanvas"></canvas>
    <div class="nova-text-wrap">
        <div class="nova-studio" id="novaTitle">NOVA STUDIO</div>
        <div class="nova-presents" id="novaPresents">–ü–†–ï–î–°–¢–ê–í–õ–Ø–ï–¢</div>
    </div>
    <div class="nova-skip">–ù–ê–ñ–ú–ò–¢–ï –ß–¢–û–ë–´ –ü–†–û–ü–£–°–¢–ò–¢–¨</div>
</div>

<!-- ============ MAIN LOAD SCREEN ============ -->
<div id="loadScreen">
    <canvas id="loadCanvas"></canvas>
    <div class="load-ui" id="loadUI">
        <div class="doom-title">DOOM RC</div>
        <div class="load-subtitle">NOVA STUDIO ENGINE</div>
        <div class="load-progress-wrap"><div class="load-progress-bar" id="loadBar"></div></div>
        <div class="load-status" id="loadStatus">–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø...</div>
    </div>
    <div class="load-ui interactive hidden" id="menuUI">
        <div class="doom-title" style="font-size:clamp(36px,8vw,90px)">DOOM RC</div>
        <div class="load-subtitle">NOVA STUDIO ENGINE</div>
        <div style="color:#777;font-size:11px;margin:20px 0 8px;letter-spacing:2px;">–í–´–ë–ï–†–ò –ö–ê–†–¢–£:</div>
        <div class="map-select" id="mapSelect">
            <div class="map-card selected" data-map="0"><div class="map-name">–ê–ù–ì–ê–†</div><div class="map-desc">–ö–ª–∞—Å—Å–∏–∫–∞</div></div>
            <div class="map-card" data-map="1"><div class="map-name">–ö–ê–¢–ê–ö–û–ú–ë–´</div><div class="map-desc">–õ–∞–±–∏—Ä–∏–Ω—Ç</div></div>
            <div class="map-card" data-map="2"><div class="map-name">–¶–ò–¢–ê–î–ï–õ–¨</div><div class="map-desc">–ê—Ä–µ–Ω–∞ + –ë–û–°–°</div></div>
            <div class="map-card" data-map="3"><div class="map-name">–ê–î</div><div class="map-desc">–§–∏–Ω–∞–ª</div></div>
        </div>
        <button class="start-btn" id="btnStart">–ù–ê–ß–ê–¢–¨ –ò–ì–†–£</button>
        <div class="hint">WASD ‚Äî –¥–≤–∏–∂–µ–Ω–∏–µ | –ú—ã—à—å ‚Äî –æ–±–∑–æ—Ä | –õ–ö–ú ‚Äî —Å—Ç—Ä–µ–ª—å–±–∞ | 1-6 ‚Äî –æ—Ä—É–∂–∏–µ | E ‚Äî –¥–≤–µ—Ä–∏<br>SHIFT ‚Äî —Å–ø—Ä–∏–Ω—Ç | CTRL ‚Äî –ø—Ä–∏—Å–µ—Å—Ç—å | F ‚Äî —Ñ–æ–Ω–∞—Ä–∏–∫ | TAB ‚Äî —Å—á—ë—Ç | ESC ‚Äî –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</div>
    </div>
</div>

<div id="deathScreen" class="overlay">
    <h1>–¢–´ –ü–û–ì–ò–ë</h1>
    <div class="death-stats" id="deathStats"></div>
    <button class="start-btn" onclick="restartGame()">–ü–ï–†–ï–†–û–î–ò–¢–¨–°–Ø</button>
</div>

<div id="winScreen" class="overlay">
    <h1>–£–†–û–í–ï–ù–¨ –ü–†–û–ô–î–ï–ù!</h1>
    <div class="win-stats" id="winStats"></div>
    <button class="start-btn" onclick="nextLevel()">–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨</button>
</div>

<div id="settingsOverlay" class="overlay">
    <div id="settingsPanel">
        <h2>–ù–ê–°–¢–†–û–ô–ö–ò</h2>
        <div class="tabs">
            <div class="tab-btn active" data-tab="tabGame">–ò–ì–†–ê</div>
            <div class="tab-btn" data-tab="tabControls">–£–ü–†–ê–í–õ–ï–ù–ò–ï</div>
            <div class="tab-btn" data-tab="tabVideo">–í–ò–î–ï–û</div>
        </div>
        <div class="tab-content active" id="tabGame">
            <div class="setting-group"><label>–ß—É–≤—Å—Ç–≤–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å –º—ã—à–∏ <span class="range-value" id="valMouse">5</span></label><input type="range" min="1" max="20" value="5" id="sliderMouse"></div>
            <div class="setting-group"><label>–°–∫–æ—Ä–æ—Å—Ç—å –¥–≤–∏–∂–µ–Ω–∏—è <span class="range-value" id="valSpeed">5</span></label><input type="range" min="1" max="10" value="5" id="sliderSpeed"></div>
            <div class="setting-group"><label>–°–ª–æ–∂–Ω–æ—Å—Ç—å</label><select id="selectDifficulty"><option value="easy">–õ—ë–≥–∫–∞—è</option><option value="normal" selected>–û–±—ã—á–Ω–∞—è</option><option value="hard">–¢—è–∂—ë–ª–∞—è</option><option value="nightmare">–ö–æ—à–º–∞—Ä</option></select></div>
            <div class="setting-group"><label>–ì—Ä–æ–º–∫–æ—Å—Ç—å <span class="range-value" id="valVolume">70</span>%</label><input type="range" min="0" max="100" value="70" id="sliderVolume"></div>
        </div>
        <div class="tab-content" id="tabControls">
            <div class="keybind-row"><span>–í–ø–µ—Ä—ë–¥</span><button class="keybind-btn" data-action="forward">W</button></div>
            <div class="keybind-row"><span>–ù–∞–∑–∞–¥</span><button class="keybind-btn" data-action="backward">S</button></div>
            <div class="keybind-row"><span>–í–ª–µ–≤–æ</span><button class="keybind-btn" data-action="left">A</button></div>
            <div class="keybind-row"><span>–í–ø—Ä–∞–≤–æ</span><button class="keybind-btn" data-action="right">D</button></div>
            <div class="keybind-row"><span>–°–ø—Ä–∏–Ω—Ç</span><button class="keybind-btn" data-action="sprint">L-SHIFT</button></div>
            <div class="keybind-row"><span>–ü—Ä–∏—Å–µ—Å—Ç—å</span><button class="keybind-btn" data-action="crouch">L-CTRL</button></div>
            <div class="keybind-row"><span>–í–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–µ</span><button class="keybind-btn" data-action="use">E</button></div>
            <div class="keybind-row"><span>–§–æ–Ω–∞—Ä–∏–∫</span><button class="keybind-btn" data-action="flashlight">F</button></div>
            <div class="keybind-row"><span>–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞</span><button class="keybind-btn" data-action="reload">R</button></div>
        </div>
        <div class="tab-content" id="tabVideo">
            <div class="setting-group"><label>–†–∞–∑—Ä–µ—à–µ–Ω–∏–µ —Ä–µ–Ω–¥–µ—Ä–∞ <span class="range-value" id="valRes">50</span>%</label><input type="range" min="20" max="100" value="50" id="sliderRes"></div>
            <div class="setting-group"><label>FOV <span class="range-value" id="valFov">70</span>deg</label><input type="range" min="50" max="120" value="70" id="sliderFov"></div>
            <div class="setting-group"><label><input type="checkbox" id="chkMinimap" checked> <span class="checkbox-label">–ú–∏–Ω–∏–∫–∞—Ä—Ç–∞</span></label></div>
            <div class="setting-group"><label><input type="checkbox" id="chkVignette" checked> <span class="checkbox-label">–í–∏–Ω—å–µ—Ç–∫–∞</span></label></div>
            <div class="setting-group"><label><input type="checkbox" id="chkFog" checked> <span class="checkbox-label">–¢—É–º–∞–Ω</span></label></div>
            <div class="setting-group"><label><input type="checkbox" id="chkFloor" checked> <span class="checkbox-label">–¢–µ–∫—Å—Ç—É—Ä–Ω—ã–π –ø–æ–ª/–ø–æ—Ç–æ–ª–æ–∫</span></label></div>
        </div>
        <div class="btn-row">
            <button class="menu-btn secondary" id="btnResetSettings">–°–ë–†–û–°</button>
            <button class="menu-btn primary" id="btnCloseSettings">–ü–†–û–î–û–õ–ñ–ò–¢–¨</button>
        </div>
    </div>
</div>

<canvas id="game"></canvas>
<div class="weapon-bar" id="weaponBar">
    <div class="weapon-slot active" data-weapon="0"><span class="wnum">1</span><span class="wicon">üî™</span><span class="wname">–ù–æ–∂</span></div>
    <div class="weapon-slot" data-weapon="1"><span class="wnum">2</span><span class="wicon">üî´</span><span class="wname">–ü–∏—Å—Ç–æ–ª–µ—Ç</span></div>
    <div class="weapon-slot" data-weapon="2"><span class="wnum">3</span><span class="wicon">üí•</span><span class="wname">–î—Ä–æ–±–æ–≤–∏–∫</span></div>
    <div class="weapon-slot" data-weapon="3"><span class="wnum">4</span><span class="wicon">‚ö°</span><span class="wname">–ü–ª–∞–∑–º–∞</span></div>
    <div class="weapon-slot" data-weapon="4"><span class="wnum">5</span><span class="wicon">ü™ö</span><span class="wname">–ü–∏–ª–∞</span></div>
    <div class="weapon-slot" data-weapon="5"><span class="wnum">6</span><span class="wicon">‚ò¢</span><span class="wname">BFG</span></div>
</div>
<div id="msgLog"></div>

<script>
// ================================================================
//  DOOM RAYCASTER ‚Äî NOVA STUDIO ENGINE
// ================================================================

// ==================== NOVA STUDIO INTRO ====================
(function novaIntroSequence(){
    const nc = document.getElementById('novaCanvas');
    const nctx = nc.getContext('2d');
    const novaTitle = document.getElementById('novaTitle');
    const novaPresents = document.getElementById('novaPresents');
    let nW, nH;
    function nResize(){ nW = nc.width = innerWidth; nH = nc.height = innerHeight; }
    nResize(); addEventListener('resize', nResize);

    // ---- Absolute timeline (milliseconds) ----
    // Phase 0: 0..800       ‚Äî fade in black, subtle dust
    // Phase 1: 800..2500    ‚Äî "NOVA STUDIO" visible (B&W)
    // Phase 2: 2500..4500   ‚Äî gunshot + heat up + cracks + sparks
    // Phase 3: 4500..5800   ‚Äî color reveal, embers
    // Phase 4: 5800..7000   ‚Äî fade out ‚Üí transition
    const TIMELINE = [0, 800, 2500, 4500, 5800];
    let t0 = -1;
    let introActive = true;
    let introRemoved = false;

    let sparks = [];
    let crackLines = [];
    let heatLevel = 0;
    let shotPlayed = false;
    let textShown = false;
    let colorApplied = false;

    // Improved crack generation ‚Äî more varied, jagged lines
    function genCracks(){
        crackLines = [];
        const count = 14 + Math.floor(Math.random()*6);
        for(let i = 0; i < count; i++){
            const baseAngle = (i/count)*Math.PI*2 + (Math.random()-0.5)*0.3;
            const totalLen = 80 + Math.random()*Math.min(nW,nH)*0.35;
            const segs = [];
            let cx = nW/2, cy = nH/2;
            const segCount = 6 + Math.floor(Math.random()*6);
            for(let j = 0; j < segCount; j++){
                const da = baseAngle + (Math.random()-0.5)*1.0;
                const dl = totalLen/segCount * (0.6 + Math.random()*0.8);
                cx += Math.cos(da)*dl;
                cy += Math.sin(da)*dl;
                segs.push({x:cx, y:cy});
            }
            // Branch probability
            if(Math.random()>0.5){
                const branchFrom = segs[Math.floor(Math.random()*Math.max(1,segs.length-2))];
                const ba = baseAngle + (Math.random()>0.5?1:-1)*(0.4+Math.random()*0.8);
                const bSegs = [];
                let bx = branchFrom.x, by = branchFrom.y;
                for(let k=0;k<3;k++){
                    bx+=Math.cos(ba+Math.random()*0.5)*20;
                    by+=Math.sin(ba+Math.random()*0.5)*20;
                    bSegs.push({x:bx,y:by});
                }
                crackLines.push({segs:bSegs, origin:branchFrom, alpha:1, width:0.8});
            }
            crackLines.push({segs, origin:{x:nW/2,y:nH/2}, alpha:1, width:1.5+Math.random()});
        }
    }

    // Improved gunshot sound ‚Äî richer layers
    function playIntroShot(){
        try {
            const ac = new (window.AudioContext||window.webkitAudioContext)();
            const now = ac.currentTime;
            // Deep sub boom ‚Äî chest punch
            const o1 = ac.createOscillator(), g1 = ac.createGain();
            o1.type='sine'; o1.frequency.setValueAtTime(90,now);
            o1.frequency.exponentialRampToValueAtTime(18,now+1.0);
            g1.gain.setValueAtTime(0.6,now);
            g1.gain.exponentialRampToValueAtTime(0.001,now+1.0);
            o1.connect(g1).connect(ac.destination); o1.start(now); o1.stop(now+1.0);
            // Transient crack ‚Äî sharp
            const o2 = ac.createOscillator(), g2 = ac.createGain();
            o2.type='sawtooth'; o2.frequency.setValueAtTime(3000,now);
            o2.frequency.exponentialRampToValueAtTime(40,now+0.12);
            g2.gain.setValueAtTime(0.4,now);
            g2.gain.exponentialRampToValueAtTime(0.001,now+0.12);
            o2.connect(g2).connect(ac.destination); o2.start(now); o2.stop(now+0.12);
            // Metal impact
            const o4 = ac.createOscillator(), g4 = ac.createGain();
            o4.type='square'; o4.frequency.setValueAtTime(1200,now);
            o4.frequency.exponentialRampToValueAtTime(100,now+0.08);
            g4.gain.setValueAtTime(0.25,now);
            g4.gain.exponentialRampToValueAtTime(0.001,now+0.08);
            o4.connect(g4).connect(ac.destination); o4.start(now); o4.stop(now+0.08);
            // Noise burst ‚Äî explosion body
            const bufLen = Math.floor(ac.sampleRate * 0.5);
            const buf = ac.createBuffer(1, bufLen, ac.sampleRate);
            const d = buf.getChannelData(0);
            for(let i=0;i<bufLen;i++) d[i]=(Math.random()*2-1)*Math.exp(-i/(ac.sampleRate*0.08));
            const ns = ac.createBufferSource(); ns.buffer = buf;
            const ng = ac.createGain();
            ng.gain.setValueAtTime(0.55,now);
            ng.gain.exponentialRampToValueAtTime(0.001,now+0.5);
            const lp = ac.createBiquadFilter(); lp.type='lowpass'; lp.frequency.value=2500;
            ns.connect(lp).connect(ng).connect(ac.destination); ns.start(now);
            // Reverb tail ‚Äî long rumble
            const o3 = ac.createOscillator(), g3 = ac.createGain();
            o3.type='sine'; o3.frequency.value=30;
            g3.gain.setValueAtTime(0,now);
            g3.gain.linearRampToValueAtTime(0.25,now+0.15);
            g3.gain.exponentialRampToValueAtTime(0.001,now+2.5);
            o3.connect(g3).connect(ac.destination); o3.start(now); o3.stop(now+2.5);
            // Glass shatter ‚Äî high freq sizzle
            const buf2 = ac.createBuffer(1, Math.floor(ac.sampleRate*0.2), ac.sampleRate);
            const d2 = buf2.getChannelData(0);
            for(let i=0;i<d2.length;i++) d2[i]=(Math.random()*2-1)*Math.exp(-i/(ac.sampleRate*0.03));
            const ns2 = ac.createBufferSource(); ns2.buffer = buf2;
            const ng2 = ac.createGain(); ng2.gain.setValueAtTime(0.3,now+0.01);
            ng2.gain.exponentialRampToValueAtTime(0.001,now+0.2);
            const hp = ac.createBiquadFilter(); hp.type='highpass'; hp.frequency.value=3000;
            ns2.connect(hp).connect(ng2).connect(ac.destination); ns2.start(now+0.01);
        } catch(e){}
    }

    function getPhase(elapsed){
        for(let i=TIMELINE.length-1;i>=0;i--) if(elapsed>=TIMELINE[i]) return i;
        return 0;
    }

    function finishIntro(){
        if(introRemoved) return;
        introRemoved = true;
        introActive = false;
        const el = document.getElementById('novaIntro');
        if(el){
            el.style.transition='opacity 0.5s';
            el.style.opacity='0';
            setTimeout(()=>{ if(el.parentNode) el.remove(); startMainLoad(); }, 500);
        }
    }

    // Click or press any key to skip intro
    document.getElementById('novaIntro').addEventListener('click', finishIntro);
    document.addEventListener('keydown', function skipIntro(e){
        if(introActive && !introRemoved){
            finishIntro();
            document.removeEventListener('keydown', skipIntro);
        }
    });

    function renderIntro(ts){
        if(!introActive) return;
        if(t0<0) t0 = ts;
        const elapsed = ts - t0;
        const phase = getPhase(elapsed);

        // Calculate local time within phase
        const phaseStart = TIMELINE[phase];
        const pTime = (elapsed - phaseStart)/1000; // seconds into current phase
        const dt = 1/60; // fixed step for particle physics

        nctx.clearRect(0,0,nW,nH);

        // Trigger text show once
        if(phase>=1 && !textShown){
            textShown = true;
            novaTitle.classList.add('visible');
            novaPresents.classList.add('visible');
        }

        // Trigger shot once
        if(phase>=2 && !shotPlayed){
            shotPlayed = true;
            playIntroShot();
            genCracks();
            // Spawn sparks
            for(let i=0;i<60;i++) sparks.push({
                x:nW/2, y:nH/2,
                vx:(Math.random()-0.5)*nW*1.2,
                vy:(Math.random()-0.5)*nH*1.2,
                life:0.5+Math.random()*1.0,
                maxLife:1.5,
                size:1+Math.random()*5,
                hue:15+Math.random()*30
            });
        }

        // Trigger color once
        if(phase>=3 && !colorApplied){
            colorApplied = true;
            novaTitle.classList.add('colored');
        }

        // Phase 4: fade out and transition ‚Äî use elapsed directly
        if(phase===4 && pTime>1.0){
            finishIntro();
            return;
        }

        // ===== PHASE 0: Black + subtle dust =====
        if(phase===0){
            nctx.fillStyle='#000'; nctx.fillRect(0,0,nW,nH);
            // Subtle noise particles fading in
            const fadeIn = Math.min(1, pTime*2);
            nctx.globalAlpha=0.02*fadeIn;
            for(let i=0;i<40;i++){
                const px = (Math.sin(i*4.1+pTime*0.4)*0.5+0.5)*nW;
                const py = (Math.cos(i*2.7+pTime*0.3)*0.5+0.5)*nH;
                nctx.fillStyle='#888';
                nctx.fillRect(px,py,2,2);
            }
            nctx.globalAlpha=1;
        }

        // ===== PHASE 1: B&W gradient with text =====
        if(phase===1){
            const g = nctx.createRadialGradient(nW/2,nH/2,0,nW/2,nH/2,nH*0.7);
            g.addColorStop(0,'#1a1a1a'); g.addColorStop(0.4,'#111'); g.addColorStop(1,'#000');
            nctx.fillStyle=g; nctx.fillRect(0,0,nW,nH);
            // Floating dust
            nctx.globalAlpha=0.04;
            for(let i=0;i<60;i++){
                const px = (Math.sin(i*3.7+pTime*0.5)*0.5+0.5)*nW;
                const py = (Math.cos(i*2.3+pTime*0.35)*0.5+0.5)*nH;
                nctx.fillStyle='#aaa';
                nctx.fillRect(px,py,1+Math.sin(i)*1,1+Math.cos(i)*1);
            }
            nctx.globalAlpha=1;
            // Subtle pulsing ring around center
            const ringAlpha = 0.06+Math.sin(pTime*2)*0.03;
            nctx.strokeStyle=`rgba(255,255,255,${ringAlpha})`;
            nctx.lineWidth=1;
            nctx.beginPath();
            nctx.arc(nW/2,nH/2, 80+Math.sin(pTime*1.5)*20, 0, Math.PI*2);
            nctx.stroke();
        }

        // ===== PHASE 2: GUNSHOT + HEAT =====
        if(phase===2){
            heatLevel = Math.min(1, pTime/1.8);
            const flashI = Math.max(0, 1-pTime*4);

            // Shake ‚Äî decreases over time
            const shakeAmt = Math.max(0, 1-pTime*1.5);
            const shakeX = (Math.random()-0.5)*40*shakeAmt;
            const shakeY = (Math.random()-0.5)*40*shakeAmt;

            // BG transitions: B&W ‚Üí heated red/orange
            const g = nctx.createRadialGradient(nW/2+shakeX*0.5,nH/2+shakeY*0.5,0,nW/2,nH/2,nH*0.7);
            const rr = Math.floor(26 + heatLevel*200);
            const gg = Math.floor(17*(1-heatLevel) + heatLevel*40);
            const bb = Math.floor(17*(1-heatLevel));
            g.addColorStop(0,`rgb(${rr},${gg},${bb})`);
            g.addColorStop(0.4,`rgb(${Math.floor(15+heatLevel*80)},${Math.floor(heatLevel*20)},${Math.floor(5*(1-heatLevel))})`);
            g.addColorStop(1,'#000');
            nctx.fillStyle=g; nctx.fillRect(0,0,nW,nH);

            // White flash
            if(flashI>0){
                nctx.fillStyle=`rgba(255,255,255,${flashI*0.9})`;
                nctx.fillRect(0,0,nW,nH);
            }

            nctx.save();
            nctx.translate(shakeX, shakeY);

            // Crack lines ‚Äî glowing, fading
            for(const cl of crackLines){
                const crackFade = Math.max(0, cl.alpha - pTime*0.25);
                if(crackFade<=0) continue;
                const glow = heatLevel*0.8;
                nctx.strokeStyle=`rgba(255,${Math.floor(120+heatLevel*135)},${Math.floor(heatLevel*80)},${crackFade})`;
                nctx.lineWidth = cl.width*(0.5+heatLevel*1.5);
                nctx.shadowColor=`rgba(255,${Math.floor(heatLevel*200)},0,${crackFade*glow})`;
                nctx.shadowBlur=8+heatLevel*25;
                nctx.beginPath();
                nctx.moveTo(cl.origin.x, cl.origin.y);
                for(const s of cl.segs) nctx.lineTo(s.x, s.y);
                nctx.stroke();
            }
            nctx.shadowBlur=0;

            // Sparks / embers
            for(const p of sparks){
                p.x+=p.vx*dt; p.y+=p.vy*dt; p.life-=dt;
                p.vx*=0.96; p.vy*=0.96; p.vy+=30*dt; // gravity
                if(p.life>0){
                    const a = (p.life/p.maxLife);
                    const sz = p.size * (0.5+a*0.5);
                    nctx.fillStyle=`hsla(${p.hue},100%,${50+a*30}%,${a})`;
                    nctx.shadowColor=`hsl(${p.hue},100%,50%)`; nctx.shadowBlur=sz*4;
                    nctx.beginPath();
                    nctx.arc(p.x, p.y, sz, 0, Math.PI*2);
                    nctx.fill();
                }
            }
            nctx.shadowBlur=0;
            sparks = sparks.filter(p=>p.life>0);

            // Heat glow rays radiating from center
            if(heatLevel>0.2){
                const numRays=20;
                for(let i=0;i<numRays;i++){
                    const a = (i/numRays)*Math.PI*2 + pTime*0.4 + Math.sin(i*7)*0.3;
                    const len = 60 + heatLevel*350 + Math.sin(i*5+pTime*6)*60;
                    const rayAlpha = (heatLevel-0.2)*0.25;
                    const grd = nctx.createLinearGradient(nW/2,nH/2,nW/2+Math.cos(a)*len,nH/2+Math.sin(a)*len);
                    grd.addColorStop(0,`rgba(255,${Math.floor(100+heatLevel*100)},0,${rayAlpha})`);
                    grd.addColorStop(1,`rgba(255,${Math.floor(50+heatLevel*50)},0,0)`);
                    nctx.strokeStyle=grd;
                    nctx.lineWidth=1.5+heatLevel*2;
                    nctx.beginPath();
                    nctx.moveTo(nW/2,nH/2);
                    nctx.lineTo(nW/2+Math.cos(a)*len, nH/2+Math.sin(a)*len);
                    nctx.stroke();
                }
            }

            // Pulsing shockwave ring
            if(pTime<1.5){
                const ringR = pTime*Math.max(nW,nH)*0.5;
                const ringA = Math.max(0, 1-pTime*0.8);
                nctx.strokeStyle=`rgba(255,200,100,${ringA*0.5})`;
                nctx.lineWidth=3+pTime*2;
                nctx.beginPath();
                nctx.arc(nW/2,nH/2,ringR,0,Math.PI*2);
                nctx.stroke();
            }

            nctx.restore();
        }

        // ===== PHASE 3: Color reveal + fiery BG =====
        if(phase===3){
            const g = nctx.createRadialGradient(nW/2,nH/2,0,nW/2,nH/2,nH*0.7);
            g.addColorStop(0,'#3a1208'); g.addColorStop(0.4,'#1a0505'); g.addColorStop(1,'#000');
            nctx.fillStyle=g; nctx.fillRect(0,0,nW,nH);
            // Rising embers
            nctx.globalAlpha=0.5;
            for(let i=0;i<30;i++){
                const px = (Math.sin(i*2.1+pTime*0.15+i*0.5)*0.45+0.5)*nW;
                const py = nH - ((i*40+pTime*80+i*30)%(nH+150));
                const sz = 1+Math.sin(i*3+pTime)*1.5;
                nctx.fillStyle=`hsl(${10+i*2+Math.sin(pTime+i)*8},95%,${45+Math.sin(i+pTime*2)*15}%)`;
                nctx.beginPath(); nctx.arc(px,py,sz,0,Math.PI*2); nctx.fill();
            }
            nctx.globalAlpha=1;
            // Subtle glow at center
            const glow = nctx.createRadialGradient(nW/2,nH/2,0,nW/2,nH/2,nH*0.3);
            glow.addColorStop(0,`rgba(255,80,20,${0.06+Math.sin(pTime*3)*0.02})`);
            glow.addColorStop(1,'rgba(0,0,0,0)');
            nctx.fillStyle=glow; nctx.fillRect(0,0,nW,nH);
        }

        // ===== PHASE 4: Fade to black =====
        if(phase>=4){
            // Remnant glow fading
            const fadeOut = Math.min(1, pTime/0.8);
            const g = nctx.createRadialGradient(nW/2,nH/2,0,nW/2,nH/2,nH*0.5);
            g.addColorStop(0,`rgba(40,12,5,${Math.max(0,1-fadeOut)})`);
            g.addColorStop(1,'rgba(0,0,0,1)');
            nctx.fillStyle=g; nctx.fillRect(0,0,nW,nH);
            // Black overlay
            nctx.fillStyle=`rgba(0,0,0,${fadeOut})`;
            nctx.fillRect(0,0,nW,nH);
        }

        requestAnimationFrame(renderIntro);
    }
    requestAnimationFrame(renderIntro);
})();

// ==================== MAIN LOADING SCREEN ====================
function startMainLoad(){
    const ls = document.getElementById('loadScreen');
    ls.classList.add('active');

    const lc = document.getElementById('loadCanvas');
    const x2d = lc.getContext('2d');
    let lW,lH;
    function rs2(){ lW=lc.width=innerWidth; lH=lc.height=innerHeight; }
    rs2(); addEventListener('resize',rs2);

    let t0 = performance.now();
    function renderLoadBg(ts){
        if(!document.getElementById('loadScreen')) return;
        const t = (ts-t0)/1000;
        const g = x2d.createRadialGradient(lW/2,lH/2,0,lW/2,lH/2,lH);
        g.addColorStop(0,`hsl(${Math.sin(t*0.5)*10+5},80%,${8+Math.sin(t*2)*3}%)`);
        g.addColorStop(0.5,'#1a0505'); g.addColorStop(1,'#000');
        x2d.fillStyle=g; x2d.fillRect(0,0,lW,lH);
        for(let i=0;i<30;i++){
            const px=(Math.sin(i*1.7+t*0.3)*0.5+0.5)*lW;
            const py=((i*0.025+t*0.05)%1)*lH;
            x2d.fillStyle=`rgba(255,${50+i*3},0,${0.2+Math.sin(i*2+t)*0.15})`;
            x2d.beginPath(); x2d.arc(px,py,2+Math.sin(i+t),0,Math.PI*2); x2d.fill();
        }
        requestAnimationFrame(renderLoadBg);
    }
    requestAnimationFrame(renderLoadBg);
    simLoad();
}

function simLoad(){
    const bar=document.getElementById('loadBar'),st=document.getElementById('loadStatus');
    const steps=[[10,'–ó–ê–ì–†–£–ó–ö–ê –¢–ï–ö–°–¢–£–†...'],[25,'–ì–ï–ù–ï–†–ê–¶–ò–Ø –ö–ê–†–¢...'],[40,'–ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –í–†–ê–ì–û–í...'],[55,'–ö–ê–õ–ò–ë–†–û–í–ö–ê –û–†–£–ñ–ò–Ø...'],[70,'–ù–ê–°–¢–†–û–ô–ö–ê –î–í–ï–†–ï–ô...'],[85,'–†–ê–ó–ú–ï–©–ï–ù–ò–ï –ë–û–ß–ï–ö...'],[95,'–ü–†–û–ë–£–ñ–î–ï–ù–ò–ï –î–ï–ú–û–ù–û–í...'],[100,'–ì–û–¢–û–í–û']];
    let i=0;
    function ns(){if(i>=steps.length){setTimeout(()=>{document.getElementById('loadUI').classList.add('hidden');document.getElementById('menuUI').classList.remove('hidden');},400);return;}
    bar.style.width=steps[i][0]+'%';st.textContent=steps[i][1];i++;setTimeout(ns,250+Math.random()*300);}
    setTimeout(ns,500);
}

// ================================================================
//  GAME ENGINE
// ================================================================
const canvas=document.getElementById('game'),ctx=canvas.getContext('2d');

// ====================== IMPROVED AUDIO ======================
const AudioCtx=window.AudioContext||window.webkitAudioContext;
let audioCtx=null,masterVolume=0.7,compressor=null;
function initAudio(){
    if(!audioCtx){
        audioCtx=new AudioCtx();
        compressor=audioCtx.createDynamicsCompressor();
        compressor.threshold.value=-20; compressor.knee.value=20;
        compressor.ratio.value=8; compressor.attack.value=0.003; compressor.release.value=0.15;
        compressor.connect(audioCtx.destination);
        genNoise();
    }
}
let noiseBuf=null;
function genNoise(){
    if(!audioCtx)return;
    const sr=audioCtx.sampleRate;
    noiseBuf=audioCtx.createBuffer(1,sr,sr);
    const d=noiseBuf.getChannelData(0);
    for(let i=0;i<d.length;i++) d[i]=Math.random()*2-1;
}
const dst=()=>compressor||(audioCtx?audioCtx.destination:null);

function makeNoise(duration, startGain, endGain, filterType, filterFreq, filterQ){
    if(!audioCtx||!noiseBuf) return;
    const now=audioCtx.currentTime, mv=masterVolume;
    const n=audioCtx.createBufferSource(); n.buffer=noiseBuf;
    const g=audioCtx.createGain();
    g.gain.setValueAtTime(startGain*mv,now);
    g.gain.exponentialRampToValueAtTime(Math.max(0.0001,endGain*mv),now+duration);
    if(filterType){
        const f=audioCtx.createBiquadFilter();
        f.type=filterType; f.frequency.value=filterFreq||1000; f.Q.value=filterQ||1;
        n.connect(f).connect(g).connect(dst());
    } else { n.connect(g).connect(dst()); }
    n.start(now); n.stop(now+duration);
}

function makeOsc(type, freqStart, freqEnd, duration, gain, detune){
    if(!audioCtx) return;
    const now=audioCtx.currentTime, mv=masterVolume;
    const o=audioCtx.createOscillator(), g=audioCtx.createGain();
    o.type=type;
    o.frequency.setValueAtTime(freqStart,now);
    if(freqEnd!==freqStart) o.frequency.exponentialRampToValueAtTime(Math.max(1,freqEnd),now+duration);
    if(detune) o.detune.value=detune;
    g.gain.setValueAtTime(gain*mv,now);
    g.gain.exponentialRampToValueAtTime(0.0001,now+duration);
    o.connect(g).connect(dst()); o.start(now); o.stop(now+duration);
}

function playSound(type){
    if(!audioCtx||masterVolume<0.01)return;
    try{
    switch(type){
        case'pistol':
            makeOsc('square',1400,60,0.1,0.3);
            makeOsc('sawtooth',800,40,0.06,0.15,10);
            makeNoise(0.07,0.45,0.001,'highpass',2000,0.5);
            makeNoise(0.04,0.3,0.001,'bandpass',4000,2);
            break;
        case'shotgun':
            makeOsc('sawtooth',300,20,0.4,0.4);
            makeOsc('square',150,15,0.35,0.25);
            makeNoise(0.25,0.6,0.001,'lowpass',2500,0.8);
            makeNoise(0.15,0.4,0.001,'highpass',1000,1);
            makeNoise(0.08,0.3,0.001,'bandpass',5000,3);
            break;
        case'plasma':
            makeOsc('sine',2200,400,0.12,0.2);
            makeOsc('square',1100,200,0.1,0.1,50);
            makeOsc('sine',3500,800,0.08,0.1);
            makeNoise(0.06,0.15,0.001,'bandpass',6000,5);
            break;
        case'knife':
            makeNoise(0.15,0.3,0.001,'bandpass',3500,3);
            makeOsc('triangle',1200,600,0.08,0.08);
            break;
        case'chainsaw':
            makeOsc('sawtooth',90,70,0.18,0.35);
            makeOsc('square',180,140,0.15,0.2,15);
            makeNoise(0.12,0.25,0.001,'bandpass',800,2);
            break;
        case'bfg':
            makeOsc('sine',50,3000,0.4,0.4);
            makeOsc('sine',3000,25,0.8,0.35);
            makeOsc('square',30,30,0.6,0.25);
            makeNoise(0.5,0.35,0.001,'lowpass',1500,1);
            makeOsc('sawtooth',100,50,0.9,0.15);
            break;
        case'hit':
            makeOsc('sine',200,50,0.06,0.35);
            makeNoise(0.05,0.3,0.001,'lowpass',1200,1);
            break;
        case'kill':
            makeOsc('sawtooth',500,30,0.5,0.3);
            makeOsc('sine',300,20,0.4,0.15);
            makeNoise(0.2,0.3,0.001,'lowpass',800,1);
            // Confirm jingle
            [600,800,1000].forEach((f,i)=>{ setTimeout(()=>makeOsc('sine',f,f*0.9,0.12,0.1),i*60); });
            break;
        case'hurt':
            makeOsc('sawtooth',350,60,0.3,0.35);
            makeOsc('square',200,40,0.25,0.2);
            makeNoise(0.15,0.3,0.001,'bandpass',1500,2);
            break;
        case'pickup':
            [523,659,784,1047].forEach((f,i)=>{ setTimeout(()=>makeOsc('sine',f,f*0.95,0.15,0.12),i*60); });
            break;
        case'door':
            makeOsc('triangle',150,40,0.6,0.2);
            makeOsc('sine',80,30,0.5,0.15);
            makeNoise(0.3,0.1,0.001,'lowpass',400,1);
            break;
        case'explode':
            makeOsc('sawtooth',120,15,0.6,0.5);
            makeOsc('sine',60,10,0.8,0.35);
            makeNoise(0.4,0.6,0.001,'lowpass',2000,0.5);
            makeNoise(0.15,0.4,0.001,'highpass',500,1);
            break;
        case'step':
            makeNoise(0.04,0.06,0.001,'lowpass',600,1);
            break;
        case'ambient':
            makeOsc('sine',35+Math.random()*20,30,4,0.04);
            makeOsc('triangle',55+Math.random()*10,50,3,0.02);
            break;
        case'secret':
            [392,494,587,784,988].forEach((f,i)=>{ setTimeout(()=>makeOsc('sine',f,f*0.95,0.18,0.14),i*80); });
            break;
        case'levelup':
            [262,330,392,523,659,784].forEach((f,i)=>{ setTimeout(()=>makeOsc('square',f,f*0.95,0.2,0.1),i*100); });
            break;
    }}catch(e){}
}

// ====================== MAPS ======================
const MAPS=[
    {name:'–ê–ù–ì–ê–†',spawn:{x:2.5,y:2.5,a:0.4},data:[
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,2,2,8,2,0,0,3,3,0,0,0,0,4,4,0,0,5,0,0,0,1],
        [1,0,0,2,0,0,2,0,0,0,3,0,0,9,0,0,4,0,0,5,0,0,0,1],
        [1,0,0,2,0,0,2,0,0,0,3,0,0,0,0,0,4,0,0,0,0,0,0,1],
        [1,0,0,2,2,0,2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,2,8,2,2,0,0,0,0,0,0,0,5,5,5,0,0,1],
        [1,0,0,0,0,0,0,2,0,0,2,0,0,0,0,0,0,0,5,0,0,0,0,1],
        [1,0,0,0,0,0,0,2,0,0,2,0,0,3,3,3,0,0,5,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,0,1],
        [1,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,9,0,1],
        [1,0,0,4,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3,3,0,0,1],
        [1,0,0,4,4,8,4,0,0,0,0,0,0,4,0,0,2,2,0,0,3,0,0,1],
        [1,0,0,0,0,0,0,0,0,3,0,0,0,4,0,0,0,2,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,3,0,0,0,4,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,5,5,0,0,0,0,3,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,2,8,2,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,9,0,1],
        [1,0,0,0,0,0,4,4,0,0,0,0,0,0,0,0,2,0,0,0,5,5,0,1],
        [1,0,0,0,0,0,0,4,0,0,3,0,0,0,0,0,0,0,0,0,5,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,3,0,0,0,0,0,0,10,0,0,0,0,0,1],
        [1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1],
        [1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1]]},
    {name:'–ö–ê–¢–ê–ö–û–ú–ë–´',spawn:{x:1.5,y:1.5,a:0},data:[
        [6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6],
        [6,0,0,0,8,0,0,0,0,0,0,0,6,0,0,0,0,0,0,6],
        [6,0,6,0,6,0,6,6,6,6,6,0,6,0,6,6,6,6,0,6],
        [6,0,6,0,0,0,0,0,0,0,6,0,0,0,6,0,0,0,0,6],
        [6,0,6,6,6,6,6,0,8,0,6,6,6,6,6,0,6,6,6,6],
        [6,0,0,0,0,0,6,0,6,0,0,0,0,0,0,0,0,0,0,6],
        [6,6,6,6,6,0,6,0,6,6,6,6,6,0,6,6,6,6,0,6],
        [6,0,0,0,0,0,0,0,0,0,0,0,6,0,6,0,0,0,0,6],
        [6,0,6,6,6,6,6,6,6,6,6,0,6,0,6,0,6,6,6,6],
        [6,0,0,0,0,0,0,0,0,0,6,0,0,0,0,0,0,9,0,6],
        [6,6,6,0,6,6,6,6,6,0,6,6,6,6,6,6,6,6,0,6],
        [6,0,0,0,6,0,0,0,0,0,0,0,0,0,0,0,0,6,0,6],
        [6,0,6,6,6,0,6,6,6,6,6,8,6,0,6,6,0,0,0,6],
        [6,0,0,0,0,0,6,0,0,0,0,0,6,0,6,0,0,6,0,6],
        [6,6,6,6,6,0,6,0,6,6,8,0,0,0,6,0,6,6,0,6],
        [6,0,0,0,0,0,0,0,6,0,0,0,6,6,6,0,0,0,0,6],
        [6,0,6,6,6,6,6,6,6,0,6,0,0,0,0,0,6,6,6,6],
        [6,0,0,0,0,0,0,0,0,0,6,0,6,6,10,0,0,0,0,6],
        [6,0,6,0,6,6,6,6,6,6,6,0,0,0,0,0,6,6,0,6],
        [6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6,6]]},
    {name:'–¶–ò–¢–ê–î–ï–õ–¨',spawn:{x:8.5,y:1.5,a:1.57},data:[
        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,8,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,9,0,0,0,0,0,0,0,9,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,8,0,0,0,0,0,0,0,0,0,0,0,8,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,2,0,0,0,2,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,9,0,0,0,0,0,0,0,9,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,8,0,0,0,0,0,0,0,3],
        [3,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,3],
        [3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3,3]]},
    {name:'–ê–î',spawn:{x:1.5,y:1.5,a:0.5},data:[
        [7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2],
        [2,0,0,0,0,0,8,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7],
        [7,0,5,5,0,0,0,0,5,0,0,2,2,0,0,5,5,0,0,0,0,2],
        [2,0,5,0,0,9,0,0,5,0,0,0,2,0,0,0,0,9,0,0,0,7],
        [7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7],
        [7,0,0,0,0,0,0,0,2,8,2,2,0,0,0,0,0,0,0,0,0,2],
        [2,0,5,0,0,0,0,0,2,0,0,2,0,0,0,0,0,0,5,0,0,7],
        [7,0,0,0,0,0,0,0,0,0,0,2,0,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,2,0,0,9,0,0,0,0,2,0,0,0,0,0,0,7],
        [7,0,0,0,0,0,2,0,0,5,0,0,0,0,2,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,0,0,0,7],
        [7,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,5,0,0,0,0,0,0,9,0,7],
        [7,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,2],
        [2,0,5,0,0,0,0,2,8,0,0,0,0,8,2,0,0,0,5,0,0,7],
        [7,0,5,0,0,9,0,0,0,0,0,0,0,0,0,0,9,0,5,0,0,2],
        [2,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,7],
        [7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2,7,2]]}
];

// ====================== WEAPONS ======================
const WEAPONS=[
    {name:'–ù–æ–∂',dmg:3,range:2,rate:0.35,spread:0,pellets:1,auto:false,sound:'knife',recoil:20,muzzle:false,color:'#ccc',ammoType:-1,magSize:999},
    {name:'–ü–∏—Å—Ç–æ–ª–µ—Ç',dmg:1,range:50,rate:0.3,spread:0.02,pellets:1,auto:false,sound:'pistol',recoil:25,muzzle:true,color:'#ff4',ammoType:0,magSize:12},
    {name:'–î—Ä–æ–±–æ–≤–∏–∫',dmg:1,range:12,rate:0.8,spread:0.08,pellets:6,auto:false,sound:'shotgun',recoil:40,muzzle:true,color:'#fa0',ammoType:1,magSize:8},
    {name:'–ü–ª–∞–∑–º–∞',dmg:2,range:50,rate:0.12,spread:0.03,pellets:1,auto:true,sound:'plasma',recoil:10,muzzle:true,color:'#4ff',ammoType:2,magSize:50},
    {name:'–ë–µ–Ω–∑–æ–ø–∏–ª–∞',dmg:5,range:2.5,rate:0.15,spread:0,pellets:1,auto:true,sound:'chainsaw',recoil:15,muzzle:false,color:'#f80',ammoType:3,magSize:100},
    {name:'BFG-9000',dmg:50,range:60,rate:2.0,spread:0.15,pellets:12,auto:false,sound:'bfg',recoil:60,muzzle:true,color:'#0f0',ammoType:4,magSize:4},
];

// ====================== ENEMIES ======================
const DEMON_TYPES=[
    {name:'Imp',hp:3,speed:1.8,dmg:8,aggroRange:8,atkRate:1.2,color:{r:200,g:60,b:40},eyeColor:'#ff0',size:0.6,horns:true,xp:10},
    {name:'Cacodemon',hp:6,speed:1.2,dmg:15,aggroRange:12,atkRate:1.5,color:{r:180,g:40,b:40},eyeColor:'#0f0',size:0.85,round:true,xp:25},
    {name:'Baron',hp:10,speed:1.4,dmg:20,aggroRange:14,atkRate:1.0,color:{r:120,g:80,b:50},eyeColor:'#f80',size:0.9,horns:true,big:true,xp:50},
    {name:'Spectre',hp:4,speed:2.5,dmg:12,aggroRange:6,atkRate:0.8,color:{r:60,g:60,b:80},eyeColor:'#88f',size:0.55,ghost:true,xp:15},
    {name:'Mancubus',hp:15,speed:0.8,dmg:25,aggroRange:16,atkRate:2.0,color:{r:160,g:120,b:80},eyeColor:'#f00',size:1.1,big:true,xp:40},
    {name:'Cyberdemon',hp:40,speed:1.0,dmg:35,aggroRange:20,atkRate:0.8,color:{r:100,g:100,b:100},eyeColor:'#f00',size:1.4,horns:true,big:true,boss:true,xp:200},
];

const settings={
    mouseSens:0.003,moveSpeed:3.5,sprintMult:1.7,fov:70*Math.PI/180,renderScale:0.5,
    showMinimap:true,showVignette:true,showFog:true,showFloorTex:true,
    difficulty:'normal',
    bindings:{forward:'KeyW',backward:'KeyS',left:'KeyA',right:'KeyD',turnLeft:'ArrowLeft',turnRight:'ArrowRight',
              sprint:'ShiftLeft',crouch:'ControlLeft',use:'KeyE',flashlight:'KeyF',reload:'KeyR'}
};
let bindRev={};function rebuildBind(){bindRev={};for(const[a,c]of Object.entries(settings.bindings))bindRev[c]=a;}rebuildBind();
const DIFF={easy:{mult:0.6,countMult:0.5},normal:{mult:1.0,countMult:1.0},hard:{mult:1.5,countMult:1.3},nightmare:{mult:2.2,countMult:1.6}};

// ====================== CANVAS ======================
let SW,SH,NUM_RAYS,zBuffer,imgData,pixels;
function resizeCanvas(){SW=Math.max(160,Math.floor(innerWidth*settings.renderScale));SH=Math.max(120,Math.floor(innerHeight*settings.renderScale));canvas.width=SW;canvas.height=SH;NUM_RAYS=SW;zBuffer=new Float64Array(NUM_RAYS);imgData=ctx.createImageData(SW,SH);pixels=imgData.data;}
resizeCanvas();addEventListener('resize',resizeCanvas);

// ====================== STATE ======================
const fx={killFlash:0,killSlowMo:0,hitMarker:0,screenShake:0,shakeX:0,shakeY:0,chromatic:0,bloodSplats:[],
    weaponKickback:0,weaponSwayX:0,weaponSwayY:0,cameraRoll:0,heartbeat:0,killStreakTimer:0,killStreak:0,
    painPulse:0,deathZoom:0,breathe:0,stepBounce:0,flashlightOn:false,
    crouchOffset:0,levelUpFlash:0};

let currentMapIndex=0,currentMap=MAPS[0];
let MAP,MAP_W,MAP_H;
const MAX_DEPTH=28;
const player={x:2.5,y:2.5,angle:0.4,radius:0.25,kills:0,health:100,maxHealth:100,armor:0,
    damageFlash:0,alive:true,weaponIndex:1,ammo:[120,50,100,100,4],score:0,xp:0,level:1,
    secrets:0,totalSecrets:0,crouching:false,regenTimer:0};
const weapon={recoilOffset:0,isRecoiling:false,recoilTimer:0,cooldown:0,muzzleFlash:0,bobPhase:0,swingPhase:0,reloading:false,reloadTimer:0};
let enemies=[],pickups=[],particles=[],doors=[],barrels=[],projectiles=[],dmgNumbers=[],messages=[];
let gameStarted=false,gamePaused=false;
const keys={};
let mouseDown=false,stepTimer=0,ambientTimer=0,gameTime=0,scoreDisplay='';

// ====================== MESSAGES ======================
function addMsg(text,color='#fff'){messages.push({text,color,life:4,maxLife:4});if(messages.length>6)messages.shift();}
function renderMessages(){const el=document.getElementById('msgLog');el.innerHTML='';messages.forEach(m=>{const d=document.createElement('div');d.className='msg-line';d.style.color=m.color;d.style.opacity=Math.min(1,m.life*2);d.textContent=m.text;el.appendChild(d);});}

// ====================== LOAD MAP ======================
function loadMap(idx){
    currentMapIndex=idx;currentMap=MAPS[idx];
    MAP=currentMap.data.map(r=>[...r]);MAP_H=MAP.length;MAP_W=MAP[0].length;
    player.x=currentMap.spawn.x;player.y=currentMap.spawn.y;player.angle=currentMap.spawn.a;
    player.health=Math.min(player.maxHealth,player.health>0?player.health:100);
    player.kills=0;player.alive=true;player.damageFlash=0;player.secrets=0;player.totalSecrets=0;player.regenTimer=0;
    player.crouching=false;
    weapon.recoilOffset=0;weapon.isRecoiling=false;weapon.cooldown=0;weapon.muzzleFlash=0;weapon.reloading=false;weapon.reloadTimer=0;
    enemies=[];pickups=[];particles=[];doors=[];barrels=[];projectiles=[];dmgNumbers=[];messages=[];gameTime=0;
    Object.keys(fx).forEach(k=>{if(typeof fx[k]==='number')fx[k]=0;});fx.bloodSplats=[];fx.flashlightOn=false;

    for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++){
        if(MAP[y][x]===8)doors.push({x,y,open:0,opening:false,closing:false,timer:0});
        if(MAP[y][x]===9){barrels.push({x:x+0.5,y:y+0.5,alive:true,health:3,radius:0.35});MAP[y][x]=0;}
        if(MAP[y][x]===10)player.totalSecrets++;
    }
    spawnEnemies();spawnPickups();
    addMsg(`–ö–ê–†–¢–ê: ${currentMap.name}`,'#ff4444');
    addMsg(`–°–õ–û–ñ–ù–û–°–¢–¨: ${settings.difficulty.toUpperCase()}`,'#ffaa44');
}

function spawnEnemies(){
    const diff=DIFF[settings.difficulty];const spawns=[];
    for(let y=1;y<MAP_H-1;y++)for(let x=1;x<MAP_W-1;x++)
        if(MAP[y][x]===0){const dx=x+0.5-player.x,dy=y+0.5-player.y;if(dx*dx+dy*dy>16)spawns.push({x:x+0.5,y:y+0.5});}
    const sh=spawns.sort(()=>Math.random()-0.5);
    let cnt=Math.min(Math.floor(10*diff.countMult),sh.length);
    if(currentMapIndex===2&&sh.length>0){
        const bt=DEMON_TYPES[5];
        enemies.push(makeEnemy(sh[0].x,sh[0].y,bt,diff));
        cnt--;sh.shift();
        addMsg('–ö–ò–ë–ï–†–î–ï–ú–û–ù –û–ë–ù–ê–†–£–ñ–ï–ù!','#ff0000');
    }
    for(let i=0;i<cnt&&i<sh.length;i++){
        const t=DEMON_TYPES[Math.floor(Math.random()*5)];
        enemies.push(makeEnemy(sh[i].x,sh[i].y,t,diff));
    }
}
function makeEnemy(x,y,t,diff){
    return{x,y,type:t,alive:true,health:Math.ceil(t.hp*diff.mult),maxHealth:Math.ceil(t.hp*diff.mult),
        speed:t.speed*(0.85+Math.random()*0.3)*Math.sqrt(diff.mult),dmg:Math.ceil(t.dmg*diff.mult),
        aggroRange:t.aggroRange,atkRate:t.atkRate/diff.mult,size:t.size,radius:0.3,
        state:'idle',stateTimer:0,angle:Math.random()*Math.PI*2,patrolTarget:null,patrolWait:0,
        attackCooldown:0,lastSeenPlayer:null,hurtTimer:0,deathTimer:0,animPhase:Math.random()*Math.PI*2,
        floatY:0,painShake:0,shootsProjectiles:!!t.boss};
}
function spawnPickups(){
    const spawns=[];
    for(let y=1;y<MAP_H-1;y++)for(let x=1;x<MAP_W-1;x++)
        if(MAP[y][x]===0){const dx=x+0.5-player.x,dy=y+0.5-player.y;if(dx*dx+dy*dy>9)spawns.push({x:x+0.5,y:y+0.5});}
    const sh=spawns.sort(()=>Math.random()-0.5);
    const types=['health','armor','shotgun_ammo','plasma_ammo','bfg_ammo','fuel'];
    for(let i=0;i<Math.min(12,sh.length);i++)
        pickups.push({x:sh[i].x,y:sh[i].y,type:types[Math.floor(Math.random()*types.length)],alive:true,bobPhase:Math.random()*Math.PI*2});
}

// ====================== CONTROLS ======================
document.addEventListener('keydown',e=>{
    if(!gameStarted)return;keys[e.code]=true;
    if(e.code==='Escape'){e.preventDefault();toggleSettings();return;}
    if(gamePaused)return;
    const a=bindRev[e.code];
    if(a==='flashlight'){fx.flashlightOn=!fx.flashlightOn;addMsg(fx.flashlightOn?'–§–æ–Ω–∞—Ä–∏–∫ –í–ö–õ':'–§–æ–Ω–∞—Ä–∏–∫ –í–´–ö–õ','#ffff44');}
    if(a==='use')interact();
    if(a==='reload')startReload();
    if(a==='crouch')player.crouching=true;
    for(let i=1;i<=6;i++)if(e.code===`Digit${i}`)selectWeapon(i-1);
    if(e.code==='KeyM'){settings.showMinimap=!settings.showMinimap;}
    if(e.code==='Tab'){e.preventDefault();scoreDisplay=scoreDisplay?'':'show';}
});
document.addEventListener('keyup',e=>{keys[e.code]=false;const a=bindRev[e.code];if(a==='crouch')player.crouching=false;});
canvas.addEventListener('click',()=>{if(gameStarted&&!gamePaused)canvas.requestPointerLock();});
document.addEventListener('mousemove',e=>{if(!gameStarted||gamePaused||!player.alive||document.pointerLockElement!==canvas)return;player.angle+=e.movementX*settings.mouseSens;});
document.addEventListener('mousedown',e=>{if(!gameStarted||gamePaused||!player.alive||e.button!==0)return;mouseDown=true;shoot();});
document.addEventListener('mouseup',e=>{if(e.button===0)mouseDown=false;});
document.addEventListener('wheel',e=>{if(!gameStarted||gamePaused)return;selectWeapon((player.weaponIndex+(e.deltaY>0?1:-1)+6)%6);});

function selectWeapon(idx){player.weaponIndex=idx;weapon.swingPhase=0;weapon.reloading=false;weapon.reloadTimer=0;document.querySelectorAll('.weapon-slot').forEach(s=>s.classList.toggle('active',parseInt(s.dataset.weapon)===idx));}

// ====================== DOORS ======================
function interact(){
    const lx=player.x+Math.cos(player.angle)*1.5,ly=player.y+Math.sin(player.angle)*1.5;
    const mx=Math.floor(lx),my=Math.floor(ly);
    for(const d of doors){
        if(d.x===mx&&d.y===my&&!d.opening&&!d.closing){
            if(d.open<0.1){d.opening=true;playSound('door');addMsg('–î–≤–µ—Ä—å –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è...','#aaa');}
            else{d.closing=true;playSound('door');}return;
        }
    }
    if(mx>=0&&mx<MAP_W&&my>=0&&my<MAP_H&&MAP[my][mx]===10){
        MAP[my][mx]=0;player.secrets++;player.score+=100;
        playSound('secret');addMsg('–°–ï–ö–†–ï–¢ –ù–ê–ô–î–ï–ù!','#ffdd00');fx.levelUpFlash=0.5;
    }
}
function updateDoors(dt){
    for(const d of doors){
        if(d.opening){d.open+=dt*2;if(d.open>=0.9){d.open=0.9;d.opening=false;d.timer=5;}}
        if(d.timer>0&&!d.opening&&d.open>0){d.timer-=dt;if(d.timer<=0)d.closing=true;}
        if(d.closing){d.open-=dt*2;if(d.open<=0){d.open=0;d.closing=false;}}
        MAP[d.y][d.x]=d.open>0.3?0:8;
    }
}

// ====================== BARRELS ======================
function explodeBarrel(b){
    if(!b.alive)return;b.alive=false;
    playSound('explode');fx.screenShake=Math.max(fx.screenShake,15);
    addMsg('–ë–û–ß–ö–ê –í–ó–û–†–í–ê–õ–ê–°–¨!','#ff8800');
    for(const e of enemies){if(!e.alive)continue;const dx=e.x-b.x,dy=e.y-b.y,d=Math.sqrt(dx*dx+dy*dy);
        if(d<3){const dmg=Math.ceil(15*(1-d/3));e.health-=dmg;e.hurtTimer=0.3;
            if(e.health<=0){e.alive=false;e.state='dead';e.deathTimer=3;player.kills++;player.score+=e.type.xp;player.xp+=e.type.xp;addMsg(`${e.type.name} —É–Ω–∏—á—Ç–æ–∂–µ–Ω!`,'#ff4444');}}}
    const dx=player.x-b.x,dy=player.y-b.y,d=Math.sqrt(dx*dx+dy*dy);
    if(d<3)damagePlayer(Math.ceil(20*(1-d/3)));
    for(const ob of barrels){if(!ob.alive||ob===b)continue;const dx2=ob.x-b.x,dy2=ob.y-b.y;if(dx2*dx2+dy2*dy2<4)setTimeout(()=>explodeBarrel(ob),150);}
    for(let i=0;i<20;i++)particles.push({x:b.x,y:b.y,vx:(Math.random()-0.5)*8,vy:(Math.random()-0.5)*8,life:0.8+Math.random()*0.5,maxLife:1.3,color:3,size:3+Math.random()*4,type:'fire'});
}

// ====================== PROJECTILES ======================
function updateProjectiles(dt){
    for(const p of projectiles){
        p.x+=p.vx*dt;p.y+=p.vy*dt;p.life-=dt;
        if(isWall(p.x,p.y)){p.life=0;continue;}
        const dx=p.x-player.x,dy=p.y-player.y;
        if(dx*dx+dy*dy<0.3){damagePlayer(p.dmg);p.life=0;}
    }
    projectiles=projectiles.filter(p=>p.life>0);
}

// ====================== COLLISION ======================
function isWall(x,y){const mx=Math.floor(x),my=Math.floor(y);if(mx<0||mx>=MAP_W||my<0||my>=MAP_H)return true;const v=MAP[my][mx];return v>0&&v!==9;}
function canMoveTo(x,y,r){return!isWall(x-r,y-r)&&!isWall(x+r,y-r)&&!isWall(x-r,y+r)&&!isWall(x+r,y+r);}
function hasLOS(x1,y1,x2,y2){const dx=x2-x1,dy=y2-y1,d=Math.sqrt(dx*dx+dy*dy),s=Math.ceil(d*4);for(let i=0;i<=s;i++){const t=i/s;if(isWall(x1+dx*t,y1+dy*t))return false;}return true;}

// ====================== SHOOTING ======================
function startReload(){if(weapon.reloading)return;weapon.reloading=true;weapon.reloadTimer=1.2;addMsg('–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞...','#aaa');}

function shoot(){
    if(!player.alive||weapon.cooldown>0||weapon.reloading)return;
    const w=WEAPONS[player.weaponIndex];
    if(w.ammoType>=0&&player.ammo[w.ammoType]<=0){addMsg('–ù–µ—Ç –ø–∞—Ç—Ä–æ–Ω–æ–≤!','#ff4444');return;}
    if(w.ammoType>=0)player.ammo[w.ammoType]--;
    weapon.isRecoiling=true;weapon.recoilTimer=0;weapon.cooldown=w.rate;weapon.muzzleFlash=w.muzzle?0.12:0;
    fx.weaponKickback=1;fx.screenShake=Math.max(fx.screenShake,w.recoil*0.15);fx.cameraRoll+=(Math.random()-0.5)*0.02;
    playSound(w.sound);

    for(let p=0;p<w.pellets;p++){
        const spread=(Math.random()-0.5)*w.spread*2,ra=player.angle+spread;
        let closest=null,closestD=w.range;
        for(const e of enemies){
            if(!e.alive)continue;
            const dx=e.x-player.x,dy=e.y-player.y,dist=Math.sqrt(dx*dx+dy*dy);
            if(dist>w.range)continue;
            let ang=Math.atan2(dy,dx)-ra;while(ang>Math.PI)ang-=2*Math.PI;while(ang<-Math.PI)ang+=2*Math.PI;
            if(Math.abs(ang)<0.08+0.2/(dist+0.5)&&dist<closestD){
                if(hasLOS(player.x,player.y,e.x,e.y)){closestD=dist;closest=e;}
            }
        }
        for(const b of barrels){
            if(!b.alive)continue;
            const dx=b.x-player.x,dy=b.y-player.y,dist=Math.sqrt(dx*dx+dy*dy);
            if(dist>w.range||dist>=closestD)continue;
            let ang=Math.atan2(dy,dx)-ra;while(ang>Math.PI)ang-=2*Math.PI;while(ang<-Math.PI)ang+=2*Math.PI;
            if(Math.abs(ang)<0.1+0.15/(dist+0.5)){b.health-=w.dmg;if(b.health<=0)explodeBarrel(b);}
        }
        if(closest){
            closest.health-=w.dmg;closest.hurtTimer=0.2;closest.painShake=0.3;closest.state='chase';closest.lastSeenPlayer={x:player.x,y:player.y};
            playSound('hit');fx.hitMarker=0.3;
            dmgNumbers.push({x:closest.x,y:closest.y,val:w.dmg,life:1,color:'#ffff00'});
            for(let i=0;i<4;i++)particles.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*3,vy:(Math.random()-0.5)*3,life:0.6+Math.random()*0.4,maxLife:1,color:1,size:2+Math.random()*3,type:'blood'});
            if(closest.health<=0){
                closest.alive=false;closest.state='dead';closest.deathTimer=3;player.kills++;
                const xpGain=closest.type.xp;player.score+=xpGain;player.xp+=xpGain;
                checkLevelUp();
                playSound('kill');fx.killStreak++;fx.killStreakTimer=2;fx.killFlash=0.5;fx.killSlowMo=0.4;fx.screenShake=Math.max(fx.screenShake,10);
                addMsg(`${closest.type.name} —É–±–∏—Ç! +${xpGain} XP`,'#ff4444');
                if(closest.type.boss)addMsg('–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù!','#ffdd00');
                for(let i=0;i<8;i++)fx.bloodSplats.push({x:0.1+Math.random()*0.8,y:0.1+Math.random()*0.8,size:0.01+Math.random()*0.04,alpha:0.4+Math.random()*0.4,life:3+Math.random()*3,dripSpeed:0.02+Math.random()*0.03,dripLen:0});
                for(let i=0;i<12;i++)particles.push({x:closest.x,y:closest.y,vx:(Math.random()-0.5)*5,vy:(Math.random()-0.5)*5,life:1+Math.random()*0.8,maxLife:1.8,color:Math.random()>0.3?1:2,size:3+Math.random()*4,type:'gib'});
            }
            alertNearby(closest.x,closest.y,6);
        }
    }
    alertNearby(player.x,player.y,10);
}
function checkLevelUp(){const needed=player.level*100;if(player.xp>=needed){player.level++;player.xp-=needed;player.maxHealth=Math.min(200,player.maxHealth+10);player.health=Math.min(player.maxHealth,player.health+25);fx.levelUpFlash=1;playSound('levelup');addMsg(`–£–†–û–í–ï–ù–¨ ${player.level}! HP+25`,'#44ff44');}}
function alertNearby(x,y,r){for(const e of enemies){if(!e.alive)continue;const dx=e.x-x,dy=e.y-y;if(dx*dx+dy*dy<r*r&&(e.state==='idle'||e.state==='patrol')){e.state='chase';e.lastSeenPlayer={x:player.x,y:player.y};}}}

// ====================== ENEMY AI ======================
function updateEnemyAI(e,dt){
    if(!e.alive){e.deathTimer-=dt;return;}
    const dx=player.x-e.x,dy=player.y-e.y,dist=Math.sqrt(dx*dx+dy*dy),angToP=Math.atan2(dy,dx);
    e.stateTimer+=dt;e.animPhase+=dt*5;if(e.hurtTimer>0)e.hurtTimer-=dt;if(e.painShake>0)e.painShake-=dt*2;if(e.attackCooldown>0)e.attackCooldown-=dt;
    if(e.type.round)e.floatY=Math.sin(e.animPhase*0.8)*0.15;
    const see=player.alive&&dist<e.aggroRange&&hasLOS(e.x,e.y,player.x,player.y);
    switch(e.state){
        case'idle':if(e.stateTimer>2+Math.random()*2){e.state='patrol';e.stateTimer=0;e.patrolTarget=findPatrol(e);}if(see){e.state='chase';e.stateTimer=0;e.lastSeenPlayer={x:player.x,y:player.y};}e.angle+=Math.sin(e.animPhase*0.3)*dt*0.5;break;
        case'patrol':if(see){e.state='chase';e.stateTimer=0;e.lastSeenPlayer={x:player.x,y:player.y};break;}if(e.patrolTarget){const pd=Math.sqrt((e.patrolTarget.x-e.x)**2+(e.patrolTarget.y-e.y)**2);if(pd<0.5){e.patrolWait+=dt;if(e.patrolWait>1.5){e.patrolTarget=findPatrol(e);e.patrolWait=0;}}else moveEnemy(e,Math.atan2(e.patrolTarget.y-e.y,e.patrolTarget.x-e.x),e.speed*0.4,dt);}if(e.stateTimer>15){e.state='idle';e.stateTimer=0;}break;
        case'chase':if(see){e.lastSeenPlayer={x:player.x,y:player.y};if(dist<2.5){e.state='attack';e.stateTimer=0;}else moveEnemy(e,angToP,e.speed,dt);}else if(e.lastSeenPlayer){const ld=Math.sqrt((e.lastSeenPlayer.x-e.x)**2+(e.lastSeenPlayer.y-e.y)**2);if(ld<0.8){e.lastSeenPlayer=null;e.state='patrol';e.stateTimer=0;}else moveEnemy(e,Math.atan2(e.lastSeenPlayer.y-e.y,e.lastSeenPlayer.x-e.x),e.speed*0.8,dt);}else{e.state='patrol';e.stateTimer=0;}break;
        case'attack':e.angle=angToP;if(!see||dist>4){e.state='chase';e.stateTimer=0;break;}if(dist>1.5)moveEnemy(e,angToP,e.speed*0.5,dt);
            if(e.attackCooldown<=0&&player.alive){
                if(e.shootsProjectiles&&dist>2){const spd=6,pdx=dx/dist*spd,pdy=dy/dist*spd;projectiles.push({x:e.x,y:e.y,vx:pdx,vy:pdy,life:3,dmg:e.dmg,color:'#f80'});}
                else{damagePlayer(e.dmg);}
                e.attackCooldown=e.atkRate*(0.8+Math.random()*0.4);
            }break;
    }
}
function moveEnemy(e,target,spd,dt){let ad=target-e.angle;while(ad>Math.PI)ad-=2*Math.PI;while(ad<-Math.PI)ad+=2*Math.PI;e.angle+=ad*Math.min(1,dt*5);const mx=Math.cos(e.angle)*spd*dt,my=Math.sin(e.angle)*spd*dt,r=e.radius;let blocked=false;for(const o of enemies){if(o===e||!o.alive)continue;if((e.x+mx-o.x)**2+(e.y+my-o.y)**2<0.25){blocked=true;break;}}if(!blocked){if(canMoveTo(e.x+mx,e.y,r))e.x+=mx;else e.angle+=(Math.random()>0.5?1:-1)*Math.PI/3;if(canMoveTo(e.x,e.y+my,r))e.y+=my;else e.angle+=(Math.random()>0.5?1:-1)*Math.PI/3;}else e.angle+=(Math.random()>0.5?1:-1)*Math.PI/3;}
function findPatrol(e){for(let i=0;i<20;i++){const a=Math.random()*Math.PI*2,d=2+Math.random()*5,tx=e.x+Math.cos(a)*d,ty=e.y+Math.sin(a)*d;if(Math.floor(tx)>0&&Math.floor(tx)<MAP_W-1&&Math.floor(ty)>0&&Math.floor(ty)<MAP_H-1&&MAP[Math.floor(ty)][Math.floor(tx)]===0)return{x:tx,y:ty};}return{x:e.x,y:e.y};}

function damagePlayer(amt){
    if(!player.alive)return;
    if(player.armor>0){const ab=Math.min(amt*0.5,player.armor);player.armor-=ab;amt-=ab;}
    player.health-=Math.ceil(amt);player.damageFlash=0.5;fx.screenShake=Math.max(fx.screenShake,8);fx.chromatic=0.4;fx.painPulse=1;
    for(let i=0;i<3;i++)fx.bloodSplats.push({x:Math.random(),y:Math.random(),size:0.02+Math.random()*0.05,alpha:0.4+Math.random()*0.3,life:2.5+Math.random()*2,dripSpeed:0.015+Math.random()*0.02,dripLen:0});
    playSound('hurt');
    if(player.health<=0){player.health=0;player.alive=false;fx.chromatic=1;fx.deathZoom=0;
        setTimeout(()=>{document.getElementById('deathStats').innerHTML=`–£–±–∏–π—Å—Ç–≤–∞: ${player.kills}<br>–°—á—ë—Ç: ${player.score}<br>–£—Ä–æ–≤–µ–Ω—å: ${player.level}<br>–ö–∞—Ä—Ç–∞: ${currentMap.name}`;document.getElementById('deathScreen').classList.add('open');document.exitPointerLock();},1200);}
}

// ====================== UPDATE ======================
function update(dt){
    gameTime+=dt;
    if(fx.killFlash>0)fx.killFlash-=dt*2;if(fx.killSlowMo>0)fx.killSlowMo-=dt;if(fx.hitMarker>0)fx.hitMarker-=dt*2;
    if(fx.chromatic>0)fx.chromatic-=dt*2;if(fx.painPulse>0)fx.painPulse-=dt*3;if(fx.weaponKickback>0)fx.weaponKickback-=dt*4;
    if(fx.killStreakTimer>0)fx.killStreakTimer-=dt;else fx.killStreak=0;
    if(fx.deathZoom<1&&!player.alive)fx.deathZoom+=dt*0.5;
    if(fx.levelUpFlash>0)fx.levelUpFlash-=dt*2;
    fx.breathe=Math.sin(gameTime*1.5)*0.003;fx.cameraRoll*=Math.max(0,1-dt*6);
    if(fx.screenShake>0){fx.screenShake*=Math.max(0,1-dt*8);fx.shakeX=(Math.random()-0.5)*fx.screenShake;fx.shakeY=(Math.random()-0.5)*fx.screenShake;if(fx.screenShake<0.1)fx.screenShake=0;}
    for(const s of fx.bloodSplats){s.life-=dt;s.dripLen+=s.dripSpeed*dt;s.alpha*=0.998;}
    fx.bloodSplats=fx.bloodSplats.filter(s=>s.life>0);
    if(player.alive&&player.health<=25){fx.heartbeat+=dt*3;if(Math.sin(fx.heartbeat)>0.9)fx.painPulse=Math.max(fx.painPulse,0.3);}
    for(const m of messages)m.life-=dt;messages=messages.filter(m=>m.life>0);renderMessages();
    for(const d of dmgNumbers){d.life-=dt;d.y-=dt*0.5;}dmgNumbers=dmgNumbers.filter(d=>d.life>0);
    const targetCrouch=player.crouching?SH*0.15:0;fx.crouchOffset+=(targetCrouch-fx.crouchOffset)*dt*10;

    const timeMult=fx.killSlowMo>0?0.3:1;const adt=dt*timeMult;
    if(!player.alive){player.angle+=adt*0.15;if(player.damageFlash>0)player.damageFlash-=dt;return;}
    if(player.health>0&&player.health<20){player.regenTimer+=dt;if(player.regenTimer>5){player.health=Math.min(player.maxHealth,player.health+1);player.regenTimer=4.5;}}else player.regenTimer=0;

    if(keys[settings.bindings.turnLeft])player.angle-=2.5*adt;
    if(keys[settings.bindings.turnRight])player.angle+=2.5*adt;

    let mx=0,my=0;const cos=Math.cos(player.angle),sin=Math.sin(player.angle);
    if(keys[settings.bindings.forward]){mx+=cos;my+=sin;}
    if(keys[settings.bindings.backward]){mx-=cos;my-=sin;}
    if(keys[settings.bindings.left]){mx+=Math.cos(player.angle-Math.PI/2);my+=Math.sin(player.angle-Math.PI/2);fx.cameraRoll-=dt*0.08;}
    if(keys[settings.bindings.right]){mx+=Math.cos(player.angle+Math.PI/2);my+=Math.sin(player.angle+Math.PI/2);fx.cameraRoll+=dt*0.08;}
    const ml=Math.sqrt(mx*mx+my*my);
    if(ml>0){
        let spd=settings.moveSpeed;if(keys[settings.bindings.sprint])spd*=settings.sprintMult;if(player.crouching)spd*=0.5;
        mx=mx/ml*spd*adt;my=my/ml*spd*adt;
        if(canMoveTo(player.x+mx,player.y,player.radius))player.x+=mx;
        if(canMoveTo(player.x,player.y+my,player.radius))player.y+=my;
        weapon.bobPhase+=adt*(keys[settings.bindings.sprint]?14:9);
        fx.stepBounce=Math.abs(Math.sin(weapon.bobPhase))*4;
        stepTimer+=adt;if(stepTimer>0.35){stepTimer=0;playSound('step');}
    }else fx.stepBounce*=0.9;

    const w=WEAPONS[player.weaponIndex];if(w.auto&&mouseDown&&weapon.cooldown<=0&&!weapon.reloading)shoot();
    if(weapon.cooldown>0)weapon.cooldown-=dt;
    if(weapon.isRecoiling){weapon.recoilTimer+=dt;const rd=0.06,ret=0.18,maxR=WEAPONS[player.weaponIndex].recoil;if(weapon.recoilTimer<rd)weapon.recoilOffset=(weapon.recoilTimer/rd)*maxR;else if(weapon.recoilTimer<rd+ret)weapon.recoilOffset=maxR*(1-Math.pow((weapon.recoilTimer-rd)/ret,2));else{weapon.recoilOffset=0;weapon.isRecoiling=false;}}
    if(weapon.muzzleFlash>0)weapon.muzzleFlash-=dt;if(player.damageFlash>0)player.damageFlash-=dt;
    weapon.swingPhase+=dt*3;fx.weaponSwayX=Math.sin(gameTime*1.2)*3;fx.weaponSwayY=Math.sin(gameTime*0.8)*2;
    if(weapon.reloading){weapon.reloadTimer-=dt;if(weapon.reloadTimer<=0){weapon.reloading=false;addMsg('–ü–µ—Ä–µ–∑–∞—Ä—è–∂–µ–Ω–æ!','#44ff44');}}

    for(const p of pickups){if(!p.alive)continue;p.bobPhase+=adt*3;
        const pdx=p.x-player.x,pdy=p.y-player.y;
        if(pdx*pdx+pdy*pdy<0.7){p.alive=false;playSound('pickup');
            switch(p.type){
                case'health':player.health=Math.min(player.maxHealth,player.health+25);addMsg('+25 HP','#44ff44');break;
                case'armor':player.armor=Math.min(100,player.armor+20);addMsg('+20 –ë—Ä–æ–Ω—è','#4488ff');break;
                case'shotgun_ammo':player.ammo[1]+=10;addMsg('+10 –î—Ä–æ–±–æ–≤–∏–∫','#ffaa44');break;
                case'plasma_ammo':player.ammo[2]+=30;addMsg('+30 –ü–ª–∞–∑–º–∞','#44ffff');break;
                case'bfg_ammo':player.ammo[4]+=1;addMsg('+1 BFG','#44ff44');break;
                case'fuel':player.ammo[3]+=25;addMsg('+25 –¢–æ–ø–ª–∏–≤–æ','#ff8844');break;
            }player.score+=5;
        }}
    for(const p of particles){p.x+=p.vx*adt;p.y+=p.vy*adt;p.life-=dt;p.vx*=0.94;p.vy*=0.94;}
    particles=particles.filter(p=>p.life>0);
    for(const e of enemies)updateEnemyAI(e,adt);
    updateDoors(dt);updateProjectiles(adt);
    ambientTimer+=dt;if(ambientTimer>10+Math.random()*5){ambientTimer=0;playSound('ambient');}

    const aliveCount=enemies.filter(e=>e.alive).length;
    if(aliveCount===0&&enemies.length>0&&!gamePaused){
        if(!window._winShown){window._winShown=true;
            setTimeout(()=>{const bonus=Math.floor(100/Math.max(1,gameTime)*10)*10;player.score+=bonus;
                document.getElementById('winStats').innerHTML=`–£–±–∏–π—Å—Ç–≤–∞: ${player.kills}<br>–°—á—ë—Ç: ${player.score}<br>–£—Ä–æ–≤–µ–Ω—å: ${player.level}<br>–ë–æ–Ω—É—Å –∑–∞ —Å–∫–æ—Ä–æ—Å—Ç—å: +${bonus}<br>–°–µ–∫—Ä–µ—Ç–æ–≤: ${player.secrets}/${player.totalSecrets}<br>–í—Ä–µ–º—è: ${Math.floor(gameTime)}—Å–µ–∫`;
                document.getElementById('winScreen').classList.add('open');document.exitPointerLock();},1500);}}
}

// ====================== WALL COLORS ======================
const WC={1:[[160,160,170],[130,130,140],[100,100,110],[80,80,90]],2:[[210,65,50],[175,55,42],[145,42,32],[115,32,25]],3:[[55,85,210],[45,70,175],[35,55,145],[28,42,115]],4:[[55,190,65],[45,155,52],[35,125,42],[28,100,32]],5:[[110,55,140],[90,45,115],[68,35,95],[50,25,75]],6:[[170,130,80],[140,108,65],[115,88,52],[90,68,40]],7:[[70,55,65],[58,45,55],[48,38,45],[38,28,35]],8:[[100,80,50],[85,68,42],[70,55,35],[55,42,28]],10:[[160,160,170],[130,130,140],[100,100,110],[80,80,90]]};

// ====================== RENDER ======================
function renderScene(){
    const hFov=settings.fov/2,hSH=SH/2,useFog=settings.showFog,useFloor=settings.showFloorTex,invMD=1/MAX_DEPTH;
    const crouchOff=Math.floor(fx.crouchOffset);
    for(let i=0;i<NUM_RAYS;i++){
        const ra=player.angle-hFov+(i/NUM_RAYS)*settings.fov,rdx=Math.cos(ra),rdy=Math.sin(ra);
        let mx2=Math.floor(player.x),my2=Math.floor(player.y);
        const ddx=Math.abs(1/rdx),ddy=Math.abs(1/rdy);let stX,stY,sdx,sdy;
        if(rdx<0){stX=-1;sdx=(player.x-mx2)*ddx}else{stX=1;sdx=(mx2+1-player.x)*ddx}
        if(rdy<0){stY=-1;sdy=(player.y-my2)*ddy}else{stY=1;sdy=(my2+1-player.y)*ddy}
        let hit=false,side=0,depth=0;
        while(!hit&&depth<MAX_DEPTH){if(sdx<sdy){sdx+=ddx;mx2+=stX;side=0}else{sdy+=ddy;my2+=stY;side=1}depth++;
            if(mx2>=0&&mx2<MAP_W&&my2>=0&&my2<MAP_H){if(MAP[my2][mx2]>0)hit=true;}else hit=true;}
        let pd;if(side===0)pd=(mx2-player.x+(1-stX)/2)/rdx;else pd=(my2-player.y+(1-stY)/2)/rdy;
        if(pd<0.1)pd=0.1;zBuffer[i]=pd;
        let wallX;if(side===0)wallX=player.y+pd*rdy;else wallX=player.x+pd*rdx;wallX-=Math.floor(wallX);
        const wt=(mx2>=0&&mx2<MAP_W&&my2>=0&&my2<MAP_H)?MAP[my2][mx2]:1;
        const ci=side===0?(stX>0?1:0):(stY>0?3:2);const wc=(WC[wt]||WC[1])[ci];
        let fwx,fwy;if(side===0){fwx=mx2+(stX>0?0:1);fwy=my2+wallX;}else{fwx=mx2+wallX;fwy=my2+(stY>0?0:1);}
        const lineH=Math.floor(SH/pd),ds=Math.floor(-lineH/2+hSH+crouchOff),de=Math.floor(lineH/2+hSH+crouchOff);
        const cs2=Math.max(0,ds),ce=Math.min(SH,de);
        const fog=useFog?Math.max(0,1-pd*invMD):1;
        const bm=(wallX*8)%1<0.06?0.75:1;
        const wr=Math.floor(wc[0]*bm*fog),wg=Math.floor(wc[1]*bm*fog),wb=Math.floor(wc[2]*bm*fog);
        for(let y=0;y<cs2;y++){const idx=(y*SW+i)*4;if(useFloor){const cd=SH/(SH-2*(y-crouchOff));const w2=cd/pd;const ffx=w2*fwx+(1-w2)*player.x,ffy=w2*fwy+(1-w2)*player.y;const ch=((Math.floor(ffx)+Math.floor(ffy))%2===0);const cf=useFog?Math.max(0,1-cd*invMD):1;const b=ch?18:10;pixels[idx]=Math.floor(b*0.6*cf);pixels[idx+1]=Math.floor(b*0.3*cf);pixels[idx+2]=Math.floor(b*1.2*cf);}else{pixels[idx]=8;pixels[idx+1]=4;pixels[idx+2]=16;}pixels[idx+3]=255;}
        const ms=lineH>30?Math.max(6,Math.floor(lineH/6)):0;
        for(let y=cs2;y<ce;y++){const idx=(y*SW+i)*4;let mr=wr,mg=wg,mb=wb;if(ms>0&&((y-ds)%ms<1)){mr=Math.floor(mr*0.75);mg=Math.floor(mg*0.75);mb=Math.floor(mb*0.75);}pixels[idx]=mr;pixels[idx+1]=mg;pixels[idx+2]=mb;pixels[idx+3]=255;}
        for(let y=ce;y<SH;y++){const idx=(y*SW+i)*4;if(useFloor){const cd=SH/(2*(y-crouchOff)-SH);const w2=cd/pd;const ffx=w2*fwx+(1-w2)*player.x,ffy=w2*fwy+(1-w2)*player.y;const ch=((Math.floor(ffx)+Math.floor(ffy))%2===0);const ff=useFog?Math.max(0,1-cd*invMD):1;const b=ch?42:28;pixels[idx]=Math.floor(b*1.1*ff);pixels[idx+1]=Math.floor(b*ff);pixels[idx+2]=Math.floor(b*0.7*ff);}else{const t=(y-ce)/(SH-ce);const v=Math.floor(20*(1-t*0.7));pixels[idx]=v;pixels[idx+1]=Math.floor(v*0.8);pixels[idx+2]=Math.floor(v*0.5);}pixels[idx+3]=255;}
    }
    ctx.putImageData(imgData,0,0);
    if(fx.flashlightOn){const g=ctx.createRadialGradient(SW/2,SH/2+fx.crouchOffset,SH*0.02,SW/2,SH/2+fx.crouchOffset,SH*0.5);g.addColorStop(0,'rgba(255,240,200,0.12)');g.addColorStop(0.4,'rgba(255,240,200,0.05)');g.addColorStop(1,'rgba(0,0,0,0)');ctx.fillStyle=g;ctx.fillRect(0,0,SW,SH);}
}

function renderSprites(){
    const hFov=settings.fov/2;const sprites=[];
    for(const e of enemies){if(!e.alive&&e.deathTimer<=0)continue;const dx=e.x-player.x,dy=e.y-player.y;sprites.push({type:'enemy',obj:e,distSq:dx*dx+dy*dy});}
    for(const p of pickups){if(!p.alive)continue;const dx=p.x-player.x,dy=p.y-player.y;sprites.push({type:'pickup',obj:p,distSq:dx*dx+dy*dy});}
    for(const b of barrels){if(!b.alive)continue;const dx=b.x-player.x,dy=b.y-player.y;sprites.push({type:'barrel',obj:b,distSq:dx*dx+dy*dy});}
    for(const p of projectiles){const dx=p.x-player.x,dy=p.y-player.y;sprites.push({type:'projectile',obj:p,distSq:dx*dx+dy*dy});}
    for(const p of particles){const dx=p.x-player.x,dy=p.y-player.y;sprites.push({type:'particle',obj:p,distSq:dx*dx+dy*dy});}
    sprites.sort((a,b)=>b.distSq-a.distSq);

    for(const s of sprites){
        const dx=s.obj.x-player.x,dy=s.obj.y-player.y,dist=Math.sqrt(s.distSq);
        let sa=Math.atan2(dy,dx)-player.angle;while(sa>Math.PI)sa-=2*Math.PI;while(sa<-Math.PI)sa+=2*Math.PI;
        if(Math.abs(sa)>hFov+0.3)continue;
        const pd=dist*Math.cos(sa);if(pd<0.3)continue;
        const screenX=Math.floor((sa/settings.fov+0.5)*SW);
        const fog=settings.showFog?Math.max(0,1-pd/MAX_DEPTH):1;

        if(s.type==='particle'){const p=s.obj;const sz=Math.max(1,Math.floor(SH/pd*0.05*p.size));const alpha=(p.life/p.maxLife)*fog;const colors=['rgba(180,0,0,','rgba(80,0,0,','rgba(255,200,50,'];ctx.fillStyle=colors[(p.color||1)-1]+alpha+')';ctx.fillRect(screenX-sz/2,SH/2-sz/2,sz,sz);continue;}
        if(s.type==='projectile'){const sz=Math.max(3,Math.floor(SH/pd*0.15));ctx.fillStyle=`rgba(255,150,50,${fog})`;ctx.shadowColor='#ff8800';ctx.shadowBlur=sz*3;ctx.beginPath();ctx.arc(screenX,SH/2+fx.crouchOffset,sz,0,Math.PI*2);ctx.fill();ctx.shadowBlur=0;continue;}
        if(s.type==='barrel'){const sz=Math.floor(SH/pd*0.4);const py=Math.floor(SH/2-sz*0.3+fx.crouchOffset);for(let sx=0;sx<sz;sx++){const c=screenX-sz/2+sx;if(c<0||c>=SW||pd>=zBuffer[c])continue;const tx=sx/sz;if(tx<0.1||tx>0.9)continue;const shade=1-Math.abs(tx-0.5)*0.6;ctx.fillStyle=`rgb(${Math.floor(80*shade*fog)},${Math.floor(50*shade*fog)},${Math.floor(20*shade*fog)})`;ctx.fillRect(c,py,1,sz*0.6);ctx.fillStyle=`rgb(${Math.floor(180*shade*fog)},${Math.floor(40*shade*fog)},0)`;ctx.fillRect(c,py+sz*0.15,1,sz*0.3);}continue;}
        if(s.type==='pickup'){const p=s.obj;const sz=Math.floor(SH/pd*0.25);const bobOff=Math.sin(p.bobPhase)*sz*0.1;const py=Math.floor(SH/2-sz/2+sz*0.15+bobOff+fx.crouchOffset);const colors={health:'#0f0',armor:'#08f',shotgun_ammo:'#fa0',plasma_ammo:'#0ff',bfg_ammo:'#0f0',fuel:'#f80'};const col=colors[p.type]||'#fff';ctx.fillStyle=col;ctx.globalAlpha=fog*0.85;for(let sx=0;sx<sz;sx++){const c=screenX-sz/2+sx;if(c<0||c>=SW||pd>=zBuffer[c])continue;const tx=sx/sz;if(tx<0.2||tx>0.8)continue;ctx.fillRect(c,py+sz*0.2,1,sz*0.5);}ctx.globalAlpha=1;continue;}

        const enemy=s.obj,sprH=Math.floor(SH/pd*enemy.size),sprW=sprH;
        const dsx=Math.floor(screenX-sprW/2);let dsy=Math.floor(SH/2-sprH/2+fx.crouchOffset);
        if(enemy.type.round)dsy-=Math.floor(enemy.floatY*sprH);
        if(!enemy.alive)dsy+=Math.floor(sprH*0.4*(1-Math.max(0,enemy.deathTimer/3)));
        const painOff=enemy.painShake>0?Math.floor(Math.sin(enemy.painShake*40)*sprW*0.05):0;
        const tc=enemy.type.color;
        for(let sx=0;sx<sprW;sx++){
            const col=dsx+sx+painOff;if(col<0||col>=SW||pd>=zBuffer[col])continue;const tx=sx/sprW;
            let br=tc.r,bg=tc.g,bb=tc.b;
            if(enemy.type.ghost&&enemy.alive)ctx.globalAlpha=0.35+Math.sin(enemy.animPhase)*0.15;
            if(!enemy.alive){const df=Math.max(0,enemy.deathTimer/3);br=Math.floor(br*0.3+80*(1-df));bg=Math.floor(bg*0.2);bb=Math.floor(bb*0.2);ctx.globalAlpha=df;}
            else if(enemy.state==='attack'){br=Math.floor(br*1.3*(0.7+Math.sin(enemy.animPhase*4)*0.3));}
            if(enemy.hurtTimer>0){const hf=enemy.hurtTimer*5;br=Math.min(255,Math.floor(br+150*hf));bg=Math.min(255,Math.floor(bg+150*hf));bb=Math.min(255,Math.floor(bb+150*hf));}
            const fr=Math.floor(br*fog),fg2=Math.floor(bg*fog),fb=Math.floor(bb*fog);
            const bTop=dsy+sprH*0.15,bBot=dsy+sprH*0.85;
            if(enemy.type.round){const cy=dsy+sprH*0.45,r=sprH*0.42,relX=(tx-0.5)*sprW,mY=Math.sqrt(Math.max(0,r*r-relX*relX));if(mY>0){const sh=1-Math.abs(tx-0.5)*0.6;ctx.fillStyle=`rgb(${Math.floor(fr*sh)},${Math.floor(fg2*sh)},${Math.floor(fb*sh)})`;ctx.fillRect(col,cy-mY,1,mY*2);if(enemy.alive&&tx>0.35&&tx<0.55){ctx.fillStyle=enemy.type.eyeColor;ctx.globalAlpha=fog;ctx.fillRect(col,cy-sprH*0.08,1,sprH*0.12);ctx.globalAlpha=enemy.type.ghost?0.35:1;}}}
            else{const mg=0.15;if(tx<mg+0.05||tx>1-mg-0.05){if(tx>mg*0.5&&tx<1-mg*0.5){let lo=0;if(enemy.alive&&(enemy.state==='chase'||enemy.state==='patrol'))lo=Math.sin(enemy.animPhase*2.5)*sprH*0.06*(tx<0.5?1:-1);ctx.fillStyle=`rgb(${Math.floor(fr*0.6)},${Math.floor(fg2*0.6)},${Math.floor(fb*0.6)})`;ctx.fillRect(col,dsy+sprH*0.7+lo,1,bBot-dsy-sprH*0.7);}continue;}
                const sh=1-Math.abs(tx-0.5)*0.4;ctx.fillStyle=`rgb(${Math.floor(fr*sh)},${Math.floor(fg2*sh)},${Math.floor(fb*sh)})`;ctx.fillRect(col,bTop,1,bBot-bTop);
                if(tx>0.25&&tx<0.75){ctx.fillStyle=`rgb(${Math.floor(fr*0.85*sh)},${Math.floor(fg2*0.8*sh)},${Math.floor(fb*0.8*sh)})`;ctx.fillRect(col,dsy+sprH*0.04,1,bTop-dsy-sprH*0.04);if(enemy.type.horns&&((tx>0.27&&tx<0.36)||(tx>0.64&&tx<0.73))){const hh=enemy.type.big?sprH*0.14:sprH*0.09;ctx.fillStyle=`rgb(${Math.floor(fr*0.5)},${Math.floor(fg2*0.4)},${Math.floor(fb*0.3)})`;ctx.fillRect(col,dsy+sprH*0.04-hh,1,hh);}}
                if(enemy.alive&&((tx>0.3&&tx<0.42)||(tx>0.58&&tx<0.7))){ctx.fillStyle=enemy.type.eyeColor;ctx.globalAlpha=fog;ctx.fillRect(col,dsy+sprH*0.09,1,sprH*0.055);ctx.globalAlpha=enemy.type.ghost?0.35:1;}
                if(enemy.type.big&&(tx<0.25||tx>0.75)){ctx.fillStyle=`rgb(${Math.floor(fr*0.7)},${Math.floor(fg2*0.7)},${Math.floor(fb*0.7)})`;ctx.fillRect(col,bTop+sprH*0.1,1,sprH*0.3);}
            }
        }
        ctx.globalAlpha=1;
        if(enemy.alive&&enemy.health<enemy.maxHealth){const bw=Math.floor(sprW*0.5),bh=Math.max(2,Math.floor(SH/pd*0.025));const bx=screenX-bw/2,by=dsy-bh-6,hp=enemy.health/enemy.maxHealth;ctx.fillStyle='rgba(0,0,0,0.7)';ctx.fillRect(bx-1,by-1,bw+2,bh+2);ctx.fillStyle=hp>0.5?'#0f0':hp>0.25?'#ff0':'#f00';ctx.fillRect(bx,by,Math.floor(bw*hp),bh);}
        if(enemy.alive&&pd<6){ctx.fillStyle='#fff';ctx.globalAlpha=fog*0.7;ctx.font=`${Math.max(8,Math.floor(SH/pd*0.04))}px Courier New`;ctx.textAlign='center';ctx.fillText(enemy.type.name+(enemy.type.boss?' ‚òÖ':''),screenX,dsy-12);ctx.globalAlpha=1;}
    }
    // Damage numbers
    for(const d of dmgNumbers){const dx2=d.x-player.x,dy2=d.y-player.y;let sa=Math.atan2(dy2,dx2)-player.angle;while(sa>Math.PI)sa-=2*Math.PI;while(sa<-Math.PI)sa+=2*Math.PI;if(Math.abs(sa)>hFov)continue;const dist2=Math.sqrt(dx2*dx2+dy2*dy2);const sx2=Math.floor((sa/settings.fov+0.5)*SW);const sy2=Math.floor(SH/2-SH/dist2*0.3+fx.crouchOffset);ctx.fillStyle=d.color;ctx.globalAlpha=Math.min(1,d.life*2);ctx.font=`bold ${Math.max(10,Math.floor(SH/dist2*0.06))}px Courier New`;ctx.textAlign='center';ctx.fillText(d.val,sx2,sy2);ctx.globalAlpha=1;}
}

function renderWeapon(){
    const cx=SW/2,by=SH;const isM=keys[settings.bindings.forward]||keys[settings.bindings.backward]||keys[settings.bindings.left]||keys[settings.bindings.right];
    const isS=isM&&keys[settings.bindings.sprint];const bi=isS?1.6:1;
    const bX=isM?Math.sin(weapon.bobPhase)*12*bi*(SW/960):0,bY=isM?Math.abs(Math.cos(weapon.bobPhase))*9*bi*(SH/600):0;
    const kb=fx.weaponKickback*fx.weaponKickback*30,rY=weapon.recoilOffset*(SH/600)+kb;
    const sX=fx.weaponSwayX*(isM?0.3:1),sY=fx.weaponSwayY*(isM?0.3:1);
    const sc=Math.min(SW/960,SH/600);const w=WEAPONS[player.weaponIndex];
    ctx.save();if(Math.abs(fx.cameraRoll)>0.001){ctx.translate(SW/2,SH/2);ctx.rotate(fx.cameraRoll);ctx.translate(-SW/2,-SH/2);}
    ctx.translate(cx+bX+fx.shakeX*2+sX,by-rY+bY+fx.shakeY*2+fx.breathe*SH+sY);ctx.scale(sc,sc);
    if(weapon.muzzleFlash>0&&w.muzzle){const mf=weapon.muzzleFlash/0.12;ctx.save();ctx.shadowColor=w.color;ctx.shadowBlur=60*mf;ctx.fillStyle=w.color;ctx.globalAlpha=mf*0.6;ctx.beginPath();ctx.ellipse(0,-220,50*mf,70*mf,0,0,Math.PI*2);ctx.fill();ctx.fillStyle='#fff';ctx.globalAlpha=mf*0.9;ctx.beginPath();ctx.ellipse(0,-220,20*mf,30*mf,0,0,Math.PI*2);ctx.fill();ctx.globalAlpha=1;ctx.shadowBlur=0;ctx.restore();}
    switch(player.weaponIndex){
        case 0:ctx.fillStyle='#c4956a';ctx.fillRect(-35,-70,70,90);const ks=Math.sin(weapon.swingPhase)*20;ctx.save();ctx.rotate(ks*Math.PI/180);ctx.fillStyle='#bbb';ctx.beginPath();ctx.moveTo(-6,-200);ctx.lineTo(6,-200);ctx.lineTo(4,-60);ctx.lineTo(-4,-60);ctx.fill();ctx.fillStyle='#888';ctx.fillRect(-16,-68,32,8);ctx.fillStyle='#5a3a1a';ctx.fillRect(-8,-60,16,35);ctx.restore();break;
        case 1:ctx.fillStyle='#c4956a';ctx.fillRect(-40,-80,80,100);ctx.fillStyle='#3a3a3a';ctx.fillRect(-12,-200,24,130);ctx.fillStyle='#1a1a1a';ctx.fillRect(-4,-208,8,12);ctx.fillStyle='#2a2a2a';ctx.fillRect(-14,-75,28,55);ctx.fillStyle='#3d2b1a';ctx.fillRect(-11,-72,10,48);ctx.fillRect(1,-72,10,48);break;
        case 2:ctx.fillStyle='#c4956a';ctx.fillRect(-45,-80,90,100);ctx.fillStyle='#333';ctx.fillRect(-18,-240,16,170);ctx.fillRect(2,-240,16,170);ctx.fillStyle='#222';ctx.beginPath();ctx.arc(-10,-240,8,0,Math.PI*2);ctx.fill();ctx.beginPath();ctx.arc(10,-240,8,0,Math.PI*2);ctx.fill();ctx.fillStyle='#5a3a1a';ctx.fillRect(-14,-75,28,70);ctx.fillStyle='#555';ctx.fillRect(-22,-155,44,18);break;
        case 3:ctx.fillStyle='#c4956a';ctx.fillRect(-40,-80,80,100);ctx.fillStyle='#2a3a4a';ctx.fillRect(-20,-220,40,155);const gp=0.6+Math.sin(weapon.swingPhase*2)*0.4;ctx.fillStyle=`rgba(0,200,255,${0.3*gp})`;ctx.beginPath();ctx.arc(0,-200,20,0,Math.PI*2);ctx.fill();ctx.fillStyle=`rgba(0,255,255,${0.6*gp})`;ctx.beginPath();ctx.arc(0,-200,10,0,Math.PI*2);ctx.fill();ctx.fillStyle='#0af';ctx.fillRect(-8,-235,16,8);break;
        case 4:ctx.fillStyle='#c4956a';ctx.fillRect(-50,-80,100,100);ctx.fillStyle='#666';ctx.fillRect(-25,-220,50,140);ctx.fillStyle='#888';ctx.fillRect(-20,-230,40,12);const teeth=Math.floor(gameTime*20)%2;for(let i=0;i<8;i++){ctx.fillStyle=i%2===teeth?'#aaa':'#ccc';ctx.fillRect(-20+i*5,-232,4,6);}ctx.fillStyle='#4a3a1a';ctx.fillRect(-18,-85,36,60);break;
        case 5:ctx.fillStyle='#c4956a';ctx.fillRect(-50,-80,100,100);ctx.fillStyle='#2a4a2a';ctx.fillRect(-25,-230,50,160);const bp=0.5+Math.sin(weapon.swingPhase*1.5)*0.5;ctx.fillStyle=`rgba(0,255,0,${0.4*bp})`;ctx.beginPath();ctx.arc(0,-210,25,0,Math.PI*2);ctx.fill();ctx.fillStyle=`rgba(0,255,0,${0.7*bp})`;ctx.beginPath();ctx.arc(0,-210,12,0,Math.PI*2);ctx.fill();ctx.fillStyle='#0f0';ctx.fillRect(-10,-245,20,10);break;
    }
    if(weapon.reloading){ctx.fillStyle='rgba(255,255,255,0.7)';ctx.font='bold 24px Courier New';ctx.textAlign='center';ctx.fillText('RELOADING',0,-280);}
    ctx.restore();
    const cs2=14,ccx=SW/2+fx.shakeX,ccy=SH/2+fx.shakeY+fx.crouchOffset;
    const cc=player.weaponIndex===3?'rgba(0,200,255,0.7)':player.weaponIndex===5?'rgba(0,255,0,0.7)':'rgba(0,255,0,0.6)';
    ctx.strokeStyle=cc;ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(ccx-cs2,ccy);ctx.lineTo(ccx-4,ccy);ctx.moveTo(ccx+4,ccy);ctx.lineTo(ccx+cs2,ccy);ctx.moveTo(ccx,ccy-cs2);ctx.lineTo(ccx,ccy-4);ctx.moveTo(ccx,ccy+4);ctx.lineTo(ccx,ccy+cs2);ctx.stroke();ctx.fillStyle=cc;ctx.fillRect(ccx-1,ccy-1,3,3);
    if(fx.hitMarker>0){const hms=8+fx.hitMarker*12;ctx.strokeStyle=`rgba(255,255,255,${Math.min(1,fx.hitMarker*4)})`;ctx.lineWidth=2;ctx.beginPath();ctx.moveTo(ccx-hms,ccy-hms);ctx.lineTo(ccx-3,ccy-3);ctx.moveTo(ccx+3,ccy-3);ctx.lineTo(ccx+hms,ccy-hms);ctx.moveTo(ccx-hms,ccy+hms);ctx.lineTo(ccx-3,ccy+3);ctx.moveTo(ccx+3,ccy+3);ctx.lineTo(ccx+hms,ccy+hms);ctx.stroke();}
}

function renderMinimap(){
    if(!settings.showMinimap)return;const ts=Math.max(3,Math.floor(Math.min(SW,SH)/MAP_W*0.25));
    const mpx=MAP_W*ts,mpy=MAP_H*ts,ox=8,oy=8;
    ctx.fillStyle='rgba(0,0,0,0.75)';ctx.fillRect(ox-2,oy-2,mpx+4,mpy+4);
    const wcs={1:'#666',2:'#a33',3:'#33a',4:'#3a3',5:'#639',6:'#a84',7:'#444',8:'#850',10:'#666'};
    for(let y=0;y<MAP_H;y++)for(let x=0;x<MAP_W;x++){ctx.fillStyle=MAP[y][x]>0?(wcs[MAP[y][x]]||'#666'):'#111';ctx.fillRect(ox+x*ts,oy+y*ts,ts-1,ts-1);}
    for(const b of barrels){if(!b.alive)continue;ctx.fillStyle='#f80';ctx.fillRect(ox+Math.floor(b.x)*ts+1,oy+Math.floor(b.y)*ts+1,ts-2,ts-2);}
    const sc2={idle:'#888',patrol:'#ff0',chase:'#f80',attack:'#f00'};
    for(const e of enemies){if(!e.alive)continue;ctx.fillStyle=sc2[e.state]||'#f00';ctx.beginPath();ctx.arc(ox+e.x*ts,oy+e.y*ts,Math.max(2,ts*0.3),0,Math.PI*2);ctx.fill();}
    const px=ox+player.x*ts,py=oy+player.y*ts;ctx.fillStyle='#0f0';ctx.beginPath();ctx.arc(px,py,Math.max(2,ts*0.35),0,Math.PI*2);ctx.fill();
    ctx.strokeStyle='#0f0';ctx.lineWidth=1.5;ctx.beginPath();ctx.moveTo(px,py);ctx.lineTo(px+Math.cos(player.angle)*ts*1.5,py+Math.sin(player.angle)*ts*1.5);ctx.stroke();
}

function renderHUD(){
    const hudH=Math.max(50,SH*0.1),fs=Math.max(10,Math.floor(hudH*0.3));
    ctx.fillStyle='rgba(0,0,0,0.8)';ctx.fillRect(0,SH-hudH,SW,hudH);ctx.fillStyle='#333';ctx.fillRect(0,SH-hudH,SW,2);
    const bw=Math.floor(SW*0.12),bh=Math.max(6,Math.floor(hudH*0.2)),bx=12,barY=SH-hudH*0.7;
    const hp=player.health/player.maxHealth;ctx.fillStyle='#222';ctx.fillRect(bx,barY,bw,bh);
    ctx.fillStyle=hp>0.5?'#0a0':hp>0.25?'#cc0':'#c00';ctx.fillRect(bx,barY,Math.floor(bw*hp),bh);
    ctx.fillStyle=hp>0.5?'#4f4':hp>0.25?'#fc0':'#f44';ctx.font=`bold ${fs}px Courier New`;ctx.textAlign='left';
    ctx.fillText(`HP:${player.health}/${player.maxHealth}`,bx,SH-hudH*0.25);
    if(player.armor>0){ctx.fillStyle='#4af';ctx.fillText(`AR:${player.armor}`,bx+bw+60,SH-hudH*0.25);}
    ctx.fillStyle='#fff';ctx.textAlign='center';const alive=enemies.filter(e=>e.alive).length;
    ctx.fillText(`K:${player.kills} | ${alive} LEFT`,SW/2,SH-hudH*0.6);
    const xpW=Math.floor(SW*0.12),xpNeeded=player.level*100,xpPct=player.xp/xpNeeded;
    ctx.fillStyle='#222';ctx.fillRect(SW/2-xpW/2,SH-hudH*0.35,xpW,4);
    ctx.fillStyle='#ff0';ctx.fillRect(SW/2-xpW/2,SH-hudH*0.35,Math.floor(xpW*xpPct),4);
    ctx.fillStyle='#888';ctx.font=`${Math.max(8,fs*0.7)}px Courier New`;
    ctx.fillText(`LVL:${player.level} XP:${player.xp}/${xpNeeded}`,SW/2,SH-hudH*0.12);
    const w=WEAPONS[player.weaponIndex];ctx.fillStyle='#fc0';ctx.textAlign='right';ctx.font=`bold ${fs}px Courier New`;
    ctx.fillText(`${w.name} ${w.ammoType<0?'INF':player.ammo[w.ammoType]}`,SW-12,SH-hudH*0.6);
    ctx.fillStyle='#aaa';ctx.font=`${Math.max(8,fs*0.7)}px Courier New`;
    ctx.fillText(`SCORE:${player.score}`,SW-12,SH-hudH*0.2);
    if(fx.killStreakTimer>0&&fx.killStreak>1){ctx.fillStyle=`rgba(255,200,50,${Math.min(1,fx.killStreakTimer)})`;ctx.font=`bold ${Math.floor(fs*1.8)}px Courier New`;ctx.textAlign='center';
        const st=['','','DOUBLE KILL!','TRIPLE KILL!','MULTI KILL!','RAMPAGE!','GODLIKE!'][Math.min(6,fx.killStreak)];ctx.fillText(st,SW/2,SH*0.3);}
    ctx.fillStyle='#444';ctx.font=`${Math.max(8,fs*0.6)}px Courier New`;ctx.textAlign='right';ctx.fillText(`FPS:${fpsDisplay}`,SW-6,Math.max(10,fs*0.7));
    if(scoreDisplay){ctx.fillStyle='rgba(0,0,0,0.85)';const sbW=Math.min(300,SW*0.4),sbH=Math.min(200,SH*0.4);ctx.fillRect(SW/2-sbW/2,SH/2-sbH/2,sbW,sbH);ctx.strokeStyle='#ff4444';ctx.lineWidth=2;ctx.strokeRect(SW/2-sbW/2,SH/2-sbH/2,sbW,sbH);ctx.fillStyle='#ff4444';ctx.font=`bold ${fs}px Courier New`;ctx.textAlign='center';ctx.fillText('STATS',SW/2,SH/2-sbH/3);ctx.fillStyle='#ddd';ctx.font=`${Math.max(9,fs*0.8)}px Courier New`;const lines=[`Kills: ${player.kills}`,`Score: ${player.score}`,`Level: ${player.level}`,`HP: ${player.health}/${player.maxHealth}`,`Time: ${Math.floor(gameTime)}s`];lines.forEach((l,i)=>ctx.fillText(l,SW/2,SH/2-sbH/3+20+i*(fs+2)));}
}

function renderPostFX(){
    ctx.save();
    if(fx.screenShake>0.5)ctx.translate(fx.shakeX,fx.shakeY);
    if(settings.showVignette){const g=ctx.createRadialGradient(SW/2,SH/2,SH*0.25,SW/2,SH/2,SH*0.85);g.addColorStop(0,'rgba(0,0,0,0)');g.addColorStop(1,'rgba(0,0,0,0.55)');ctx.fillStyle=g;ctx.fillRect(-10,-10,SW+20,SH+20);}
    if(weapon.muzzleFlash>0){ctx.fillStyle=`rgba(255,200,80,${Math.min(0.25,weapon.muzzleFlash*4)})`;ctx.fillRect(-10,-10,SW+20,SH+20);}
    if(fx.killFlash>0){const kg=ctx.createRadialGradient(SW/2,SH/2,SH*0.05,SW/2,SH/2,SH*0.7);kg.addColorStop(0,`rgba(255,255,220,${fx.killFlash*0.35})`);kg.addColorStop(1,`rgba(255,100,0,${fx.killFlash*0.1})`);ctx.fillStyle=kg;ctx.fillRect(-10,-10,SW+20,SH+20);}
    if(fx.painPulse>0){const pg=ctx.createRadialGradient(SW/2,SH/2,SH*0.1,SW/2,SH/2,SH*0.5);pg.addColorStop(0,'rgba(0,0,0,0)');pg.addColorStop(1,`rgba(200,0,0,${fx.painPulse*0.4})`);ctx.fillStyle=pg;ctx.fillRect(-10,-10,SW+20,SH+20);}
    if(player.damageFlash>0){ctx.fillStyle=`rgba(180,0,0,${player.damageFlash*0.6})`;ctx.fillRect(-10,-10,SW+20,SH+20);}
    if(fx.levelUpFlash>0){ctx.fillStyle=`rgba(255,255,100,${fx.levelUpFlash*0.3})`;ctx.fillRect(-10,-10,SW+20,SH+20);}
    for(const sp of fx.bloodSplats){const sx=sp.x*SW,sy=sp.y*SH,sz=sp.size*SH;ctx.fillStyle=`rgba(120,0,0,${sp.alpha*Math.min(1,sp.life)})`;ctx.beginPath();ctx.ellipse(sx,sy,sz*1.3,sz*0.9,sp.x*3,0,Math.PI*2);ctx.fill();if(sp.dripLen>0){ctx.fillStyle=`rgba(100,0,0,${sp.alpha*0.6*Math.min(1,sp.life)})`;ctx.fillRect(sx-sz*0.15,sy,sz*0.3,sp.dripLen*SH);}}
    if(fx.chromatic>0.05){const off=Math.floor(fx.chromatic*5)+1;ctx.globalCompositeOperation='lighter';ctx.globalAlpha=fx.chromatic*0.12;ctx.drawImage(canvas,-off,0);ctx.drawImage(canvas,off,0);ctx.globalCompositeOperation='source-over';ctx.globalAlpha=1;}
    if(!player.alive){const da=Math.min(1,fx.deathZoom);ctx.fillStyle=`rgba(60,0,0,${da*0.6})`;ctx.fillRect(-10,-10,SW+20,SH+20);ctx.fillStyle=`rgba(0,0,0,${da*0.2})`;for(let y=0;y<SH;y+=2)ctx.fillRect(0,y,SW,1);}
    if(fx.killSlowMo>0){ctx.strokeStyle=`rgba(255,200,50,${fx.killSlowMo*1.5})`;ctx.lineWidth=2;ctx.strokeRect(2,2,SW-4,SH-4);}
    ctx.restore();
}

// ====================== GAME LOOP ======================
let lastTime=0,fpsCounter=0,fpsTime=0,fpsDisplay=60;
function gameLoop(ts){
    const dt=Math.min((ts-lastTime)/1000,0.05);lastTime=ts;
    fpsCounter++;fpsTime+=dt;if(fpsTime>=0.5){fpsDisplay=Math.round(fpsCounter/fpsTime);fpsCounter=0;fpsTime=0;}
    if(!gamePaused)update(dt);
    pixels.fill(0);for(let i=3;i<pixels.length;i+=4)pixels[i]=255;
    renderScene();renderSprites();renderPostFX();if(player.alive)renderWeapon();renderMinimap();renderHUD();
    requestAnimationFrame(gameLoop);
}

// ====================== SETTINGS UI ======================
function toggleSettings(){const ov=document.getElementById('settingsOverlay');gamePaused=!gamePaused;if(gamePaused){ov.classList.add('open');document.exitPointerLock();}else ov.classList.remove('open');}
document.querySelectorAll('.tab-btn').forEach(b=>{b.addEventListener('click',()=>{document.querySelectorAll('.tab-btn').forEach(x=>x.classList.remove('active'));document.querySelectorAll('.tab-content').forEach(x=>x.classList.remove('active'));b.classList.add('active');document.getElementById(b.dataset.tab).classList.add('active');});});
document.getElementById('sliderMouse').addEventListener('input',function(){document.getElementById('valMouse').textContent=this.value;settings.mouseSens=this.value*0.001;});
document.getElementById('sliderSpeed').addEventListener('input',function(){document.getElementById('valSpeed').textContent=this.value;settings.moveSpeed=1.5+this.value*0.4;});
document.getElementById('sliderFov').addEventListener('input',function(){document.getElementById('valFov').textContent=this.value;settings.fov=this.value*Math.PI/180;});
document.getElementById('sliderVolume').addEventListener('input',function(){document.getElementById('valVolume').textContent=this.value;masterVolume=this.value/100;});
document.getElementById('sliderRes').addEventListener('input',function(){document.getElementById('valRes').textContent=this.value;settings.renderScale=this.value/100;resizeCanvas();});
document.getElementById('chkMinimap').addEventListener('change',function(){settings.showMinimap=this.checked;});
document.getElementById('chkVignette').addEventListener('change',function(){settings.showVignette=this.checked;});
document.getElementById('chkFog').addEventListener('change',function(){settings.showFog=this.checked;});
document.getElementById('chkFloor').addEventListener('change',function(){settings.showFloorTex=this.checked;});
document.getElementById('selectDifficulty').addEventListener('change',function(){settings.difficulty=this.value;});
let listeningBtn=null;
document.querySelectorAll('.keybind-btn').forEach(b=>{b.addEventListener('click',function(){if(listeningBtn)listeningBtn.classList.remove('listening');listeningBtn=this;this.classList.add('listening');this.textContent='...';});});
document.addEventListener('keydown',function(e){if(!listeningBtn)return;e.preventDefault();e.stopPropagation();settings.bindings[listeningBtn.dataset.action]=e.code;listeningBtn.textContent=prettyKey(e.code);listeningBtn.classList.remove('listening');listeningBtn=null;rebuildBind();},true);
function prettyKey(c){const m={KeyW:'W',KeyA:'A',KeyS:'S',KeyD:'D',KeyE:'E',KeyF:'F',KeyM:'M',KeyR:'R',Space:'SPACE',ShiftLeft:'L-SHIFT',ControlLeft:'L-CTRL',ArrowLeft:'<-',ArrowRight:'->'};return m[c]||c.replace('Key','').replace('Digit','');}
document.getElementById('btnCloseSettings').addEventListener('click',toggleSettings);
document.getElementById('btnResetSettings').addEventListener('click',()=>{settings.mouseSens=0.005;settings.moveSpeed=3.5;settings.fov=70*Math.PI/180;settings.renderScale=0.5;settings.showMinimap=true;settings.showVignette=true;settings.showFog=true;settings.showFloorTex=true;settings.difficulty='normal';masterVolume=0.7;settings.bindings={forward:'KeyW',backward:'KeyS',left:'KeyA',right:'KeyD',turnLeft:'ArrowLeft',turnRight:'ArrowRight',sprint:'ShiftLeft',crouch:'ControlLeft',use:'KeyE',flashlight:'KeyF',reload:'KeyR'};rebuildBind();document.getElementById('sliderMouse').value=5;document.getElementById('valMouse').textContent='5';document.getElementById('sliderSpeed').value=5;document.getElementById('valSpeed').textContent='5';document.getElementById('sliderFov').value=70;document.getElementById('valFov').textContent='70';document.getElementById('sliderVolume').value=70;document.getElementById('valVolume').textContent='70';document.getElementById('sliderRes').value=50;document.getElementById('valRes').textContent='50';document.getElementById('selectDifficulty').value='normal';document.getElementById('chkMinimap').checked=true;document.getElementById('chkVignette').checked=true;document.getElementById('chkFog').checked=true;document.getElementById('chkFloor').checked=true;resizeCanvas();document.querySelectorAll('.keybind-btn').forEach(b=>{b.textContent=prettyKey(settings.bindings[b.dataset.action]);});});
document.querySelectorAll('.map-card').forEach(c=>{c.addEventListener('click',()=>{document.querySelectorAll('.map-card').forEach(x=>x.classList.remove('selected'));c.classList.add('selected');});});
document.querySelectorAll('.weapon-slot').forEach(s=>{s.addEventListener('click',()=>{if(gameStarted&&!gamePaused)selectWeapon(parseInt(s.dataset.weapon));});});

document.getElementById('btnStart').addEventListener('click',()=>{
    initAudio();
    const sel=document.querySelector('.map-card.selected');const mapIdx=sel?parseInt(sel.dataset.map):0;
    const ls=document.getElementById('loadScreen');if(ls){ls.style.transition='opacity 0.5s';ls.style.opacity='0';setTimeout(()=>ls.remove(),500);}
    canvas.classList.add('active');document.getElementById('weaponBar').classList.add('active');
    gameStarted=true;window._winShown=false;loadMap(mapIdx);canvas.requestPointerLock();playSound('ambient');
});

function restartGame(){document.getElementById('deathScreen').classList.remove('open');player.health=100;player.maxHealth=100;player.armor=0;player.score=0;player.xp=0;player.level=1;player.ammo=[120,50,100,100,4];window._winShown=false;loadMap(currentMapIndex);canvas.requestPointerLock();}
function nextLevel(){document.getElementById('winScreen').classList.remove('open');const next=(currentMapIndex+1)%MAPS.length;window._winShown=false;loadMap(next);canvas.requestPointerLock();addMsg('–°–õ–ï–î–£–Æ–©–ò–ô –£–†–û–í–ï–ù–¨!','#44ff44');}
window.restartGame=restartGame;window.nextLevel=nextLevel;

document.querySelectorAll('.keybind-btn').forEach(b=>{b.textContent=prettyKey(settings.bindings[b.dataset.action]);});
requestAnimationFrame(gameLoop);
</script>
</body>
</html>
